import { Component, ViewChild, Input, } from "@angular/core";
import { CommonModule } from "@angular/common";
import Blocks from "../../components/blocks/blocks";
import DynamicDiv from "../../components/dynamic-div";
import DynamicRenderer from "../../components/dynamic-renderer/dynamic-renderer";
import InlinedStyles from "../../components/inlined-styles";
import { getSizesForBreakpoints } from "../../constants/device-sizes";
import { TARGET } from "../../constants/target";
import { getClassPropName } from "../../functions/get-class-prop-name";
import { mapStyleObjToStrIfNeeded } from "../../functions/get-style";
import { getColumnsClass } from "./helpers";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export default class Columns {
    get gutterSize() {
        return typeof this.space === "number" ? this.space || 0 : 20;
    }
    get cols() {
        return this.columns || [];
    }
    get stackAt() {
        return this.stackColumnsAt || "tablet";
    }
    getTagName(column) {
        return column.link ? this.builderLinkComponent || "a" : DynamicDiv;
    }
    getWidth(index) {
        return this.cols[index]?.width || 100 / this.cols.length;
    }
    getColumnCssWidth(index) {
        const width = this.getWidth(index);
        const subtractWidth = this.gutterSize * (this.cols.length - 1) * (width / 100);
        return `calc(${width}% - ${subtractWidth}px)`;
    }
    getTabletStyle({ stackedStyle, desktopStyle, }) {
        return this.stackAt === "tablet" ? stackedStyle : desktopStyle;
    }
    getMobileStyle({ stackedStyle, desktopStyle, }) {
        return this.stackAt === "never" ? desktopStyle : stackedStyle;
    }
    get flexDir() {
        return this.stackColumnsAt === "never"
            ? "row"
            : this.reverseColumnsWhenStacked
                ? "column-reverse"
                : "column";
    }
    columnsCssVars() {
        return {
            "--flex-dir": this.flexDir,
            "--flex-dir-tablet": this.getTabletStyle({
                stackedStyle: this.flexDir,
                desktopStyle: "row",
            }),
        };
    }
    columnCssVars(index) {
        const gutter = index === 0 ? 0 : this.gutterSize;
        const width = this.getColumnCssWidth(index);
        const gutterPixels = `${gutter}px`;
        const mobileWidth = "100%";
        const mobileMarginLeft = 0;
        const marginLeftKey = "margin-left";
        const sharedStyles = {
            display: "flex",
            flexDirection: "column",
            alignItems: "stretch",
        };
        return {
            ...sharedStyles,
            width,
            [marginLeftKey]: gutterPixels,
            "--column-width-mobile": this.getMobileStyle({
                stackedStyle: mobileWidth,
                desktopStyle: width,
            }),
            "--column-margin-left-mobile": this.getMobileStyle({
                stackedStyle: mobileMarginLeft,
                desktopStyle: gutterPixels,
            }),
            "--column-width-tablet": this.getTabletStyle({
                stackedStyle: mobileWidth,
                desktopStyle: width,
            }),
            "--column-margin-left-tablet": this.getTabletStyle({
                stackedStyle: mobileMarginLeft,
                desktopStyle: gutterPixels,
            }),
        };
    }
    getWidthForBreakpointSize(size) {
        const breakpointSizes = getSizesForBreakpoints(this.builderContext.content?.meta?.breakpoints || {});
        return breakpointSizes[size].max;
    }
    columnsStyles() {
        const childColumnDiv = `.${this.builderBlock.id}-breakpoints .builder-column:first-of-type`;
        return `
        @media (max-width: ${this.getWidthForBreakpointSize("medium")}px) {
          .${this.builderBlock.id}-breakpoints {
            flex-direction: var(--flex-dir-tablet);
            align-items: stretch;
          }

          ${childColumnDiv} {
            width: var(--column-width-tablet) !important;
            margin-left: var(--column-margin-left-tablet) !important;
          }
        }

        @media (max-width: ${this.getWidthForBreakpointSize("small")}px) {
          .${this.builderBlock.id}-breakpoints {
            flex-direction: var(--flex-dir);
            align-items: stretch;
          }

          ${childColumnDiv} {
            width: var(--column-width-mobile) !important;
            margin-left: var(--column-margin-left-mobile) !important;
          }
        },
      `;
    }
    getAttributes(column, index) {
        return {
            ...{},
            ...(column.link
                ? {
                    href: column.link,
                }
                : {}),
            [getClassPropName()]: "builder-column",
            style: mapStyleObjToStrIfNeeded(this.columnCssVars(index)),
        };
    }
    setAttributes(el, value, changes) {
        if (!el) {
            return;
        }
        const target = typeof changes === "undefined" ? value : changes;
        Object.keys(target).forEach((key) => {
            if (key.startsWith("on")) {
                if (this._listenerFns.has(key)) {
                    this._listenerFns.get(key)();
                }
                this._listenerFns.set(key, this.renderer.listen(el, key.replace("on", "").toLowerCase(), target[key]));
            }
            else {
                this.renderer.setAttribute(el, key.toLowerCase(), target[key] ?? "");
            }
        });
    }
    trackByColumn0(index, column) {
        return index;
    }
    constructor(renderer) {
        this.renderer = renderer;
        this.TARGET = TARGET;
        this._listenerFns = new Map();
        this.node_0_div = null;
        this.node_1_div = null;
        this.node_2_InlinedStyles = null;
        this.node_3_DynamicRenderer = (column, index) => this.getTagName(column);
        this.node_4_DynamicRenderer = (column, index) => ({});
        this.node_5_DynamicRenderer = (column, index) => this.getAttributes(column, index);
        this.node_6_Blocks = (column, index) => `columns.${index}.blocks`;
        this.node_7_Blocks = (column, index) => ({
            flexGrow: "1",
        });
        this.elRef0_state_0 = null;
    }
    ngOnInit() {
        this.node_0_div = getColumnsClass(this.builderBlock?.id);
        this.node_1_div = this.columnsCssVars();
        this.node_2_InlinedStyles = this.columnsStyles();
        this.elRef0_state_0 = {};
    }
    ngAfterViewInit() {
        this.setAttributes(this.elRef0?.nativeElement, this.elRef0_state_0);
    }
    ngOnChanges(changes) {
        if (typeof window !== "undefined") {
            this.node_0_div = getColumnsClass(this.builderBlock?.id);
            this.node_1_div = this.columnsCssVars();
            this.node_2_InlinedStyles = this.columnsStyles();
            this.elRef0_state_0 = {};
            this.setAttributes(this.elRef0?.nativeElement, this.elRef0_state_0, changes["elRef0_state_0"]?.currentValue);
        }
    }
    ngOnDestroy() {
        for (const fn of this._listenerFns.values()) {
            fn();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: Columns, deps: [{ token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: Columns, isStandalone: true, selector: "columns", inputs: { builderBlock: "builderBlock", space: "space", columns: "columns", stackColumnsAt: "stackColumnsAt", builderLinkComponent: "builderLinkComponent", reverseColumnsWhenStacked: "reverseColumnsWhenStacked", builderContext: "builderContext", builderComponents: "builderComponents" }, viewQueries: [{ propertyName: "elRef0", first: true, predicate: ["elRef0"], descendants: true }], usesOnChanges: true, ngImport: i0, template: `
    <div [class]="node_0_div + ' div'" [ngStyle]="node_1_div" #elRef0>
      <ng-container *ngIf="TARGET !== 'reactNative'">
        <inlined-styles
          id="builderio-columns"
          [styles]="node_2_InlinedStyles"
          [nonce]="builderContext.nonce"
        ></inlined-styles>
      </ng-container>
      <ng-container
        *ngFor="let column of columns; index as index; trackBy: trackByColumn0"
      >
        <dynamic-renderer
          [TagName]="node_3_DynamicRenderer(column, index)"
          [actionAttributes]="node_4_DynamicRenderer(column, index)"
          [attributes]="node_5_DynamicRenderer(column, index)"
        >
          <blocks
            [path]="node_6_Blocks(column, index)"
            [parent]="builderBlock.id"
            [context]="builderContext"
            [registeredComponents]="builderComponents"
            [linkComponent]="builderLinkComponent"
            [blocks]="column.blocks"
            [styleProp]="node_7_Blocks(column, index)"
          ></blocks>
        </dynamic-renderer>
      </ng-container>
    </div>
  `, isInline: true, styles: [":host{display:contents}.div{display:flex;line-height:normal}\n"], dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "component", type: InlinedStyles, selector: "inlined-styles, InlinedStyles", inputs: ["styles", "id", "nonce"] }, { kind: "component", type: DynamicRenderer, selector: "dynamic-renderer, DynamicRenderer", inputs: ["TagName", "attributes", "actionAttributes"] }, { kind: "component", type: Blocks, selector: "blocks", inputs: ["blocks", "parent", "path", "styleProp", "className", "context", "linkComponent", "registeredComponents"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: Columns, decorators: [{
            type: Component,
            args: [{ selector: "columns", template: `
    <div [class]="node_0_div + ' div'" [ngStyle]="node_1_div" #elRef0>
      <ng-container *ngIf="TARGET !== 'reactNative'">
        <inlined-styles
          id="builderio-columns"
          [styles]="node_2_InlinedStyles"
          [nonce]="builderContext.nonce"
        ></inlined-styles>
      </ng-container>
      <ng-container
        *ngFor="let column of columns; index as index; trackBy: trackByColumn0"
      >
        <dynamic-renderer
          [TagName]="node_3_DynamicRenderer(column, index)"
          [actionAttributes]="node_4_DynamicRenderer(column, index)"
          [attributes]="node_5_DynamicRenderer(column, index)"
        >
          <blocks
            [path]="node_6_Blocks(column, index)"
            [parent]="builderBlock.id"
            [context]="builderContext"
            [registeredComponents]="builderComponents"
            [linkComponent]="builderLinkComponent"
            [blocks]="column.blocks"
            [styleProp]="node_7_Blocks(column, index)"
          ></blocks>
        </dynamic-renderer>
      </ng-container>
    </div>
  `, standalone: true, imports: [CommonModule, InlinedStyles, DynamicRenderer, Blocks], styles: [":host{display:contents}.div{display:flex;line-height:normal}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }]; }, propDecorators: { builderBlock: [{
                type: Input
            }], space: [{
                type: Input
            }], columns: [{
                type: Input
            }], stackColumnsAt: [{
                type: Input
            }], builderLinkComponent: [{
                type: Input
            }], reverseColumnsWhenStacked: [{
                type: Input
            }], builderContext: [{
                type: Input
            }], builderComponents: [{
                type: Input
            }], elRef0: [{
                type: ViewChild,
                args: ["elRef0"]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9ibG9ja3MvY29sdW1ucy9jb2x1bW5zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsU0FBUyxFQUdULEtBQUssR0FFTixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJL0MsT0FBTyxNQUFNLE1BQU0sZ0NBQWdDLENBQUM7QUFDcEQsT0FBTyxVQUFVLE1BQU0sOEJBQThCLENBQUM7QUFDdEQsT0FBTyxlQUFlLE1BQU0sb0RBQW9ELENBQUM7QUFDakYsT0FBTyxhQUFhLE1BQU0saUNBQWlDLENBQUM7QUFFNUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDdEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRWhELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBR3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7OztBQWdENUMsTUFBTSxDQUFDLE9BQU8sT0FBTyxPQUFPO0lBZ0IxQixJQUFJLFVBQVU7UUFDWixPQUFPLE9BQU8sSUFBSSxDQUFDLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDL0QsQ0FBQztJQUNELElBQUksSUFBSTtRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUNELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLGNBQWMsSUFBSSxRQUFRLENBQUM7SUFDekMsQ0FBQztJQUNELFVBQVUsQ0FBQyxN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dEIsS0FBSztnQkFDRyxpQkFBaUI7c0JBQXpCLEtBQUs7Z0JBRWUsTUFBTTtzQkFBMUIsU0FBUzt1QkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBWaWV3Q2hpbGQsXG4gIEVsZW1lbnRSZWYsXG4gIFJlbmRlcmVyMixcbiAgSW5wdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBDb21tb25Nb2R1bGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uXCI7XG5cbnR5cGUgQ1NTVmFsID0gc3RyaW5nIHwgbnVtYmVyO1xuXG5pbXBvcnQgQmxvY2tzIGZyb20gXCIuLi8uLi9jb21wb25lbnRzL2Jsb2Nrcy9ibG9ja3NcIjtcbmltcG9ydCBEeW5hbWljRGl2IGZyb20gXCIuLi8uLi9jb21wb25lbnRzL2R5bmFtaWMtZGl2XCI7XG5pbXBvcnQgRHluYW1pY1JlbmRlcmVyIGZyb20gXCIuLi8uLi9jb21wb25lbnRzL2R5bmFtaWMtcmVuZGVyZXIvZHluYW1pYy1yZW5kZXJlclwiO1xuaW1wb3J0IElubGluZWRTdHlsZXMgZnJvbSBcIi4uLy4uL2NvbXBvbmVudHMvaW5saW5lZC1zdHlsZXNcIjtcbmltcG9ydCB0eXBlIHsgU2l6ZU5hbWUgfSBmcm9tIFwiLi4vLi4vY29uc3RhbnRzL2RldmljZS1zaXplc1wiO1xuaW1wb3J0IHsgZ2V0U2l6ZXNGb3JCcmVha3BvaW50cyB9IGZyb20gXCIuLi8uLi9jb25zdGFudHMvZGV2aWNlLXNpemVzXCI7XG5pbXBvcnQgeyBUQVJHRVQgfSBmcm9tIFwiLi4vLi4vY29uc3RhbnRzL3RhcmdldFwiO1xuaW1wb3J0IHsgZGVvcHRTaWduYWwgfSBmcm9tIFwiLi4vLi4vZnVuY3Rpb25zL2Rlb3B0XCI7XG5pbXBvcnQgeyBnZXRDbGFzc1Byb3BOYW1lIH0gZnJvbSBcIi4uLy4uL2Z1bmN0aW9ucy9nZXQtY2xhc3MtcHJvcC1uYW1lXCI7XG5pbXBvcnQgeyBtYXBTdHlsZU9ialRvU3RySWZOZWVkZWQgfSBmcm9tIFwiLi4vLi4vZnVuY3Rpb25zL2dldC1zdHlsZVwiO1xuaW1wb3J0IHR5cGUgeyBEaWN0aW9uYXJ5IH0gZnJvbSBcIi4uLy4uL3R5cGVzL3R5cGVzY3JpcHRcIjtcbmltcG9ydCB0eXBlIHsgQ29sdW1uLCBDb2x1bW5Qcm9wcyB9IGZyb20gXCIuL2NvbHVtbnMudHlwZXNcIjtcbmltcG9ydCB7IGdldENvbHVtbnNDbGFzcyB9IGZyb20gXCIuL2hlbHBlcnNcIjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcImNvbHVtbnNcIixcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZGl2IFtjbGFzc109XCJub2RlXzBfZGl2ICsgJyBkaXYnXCIgW25nU3R5bGVdPVwibm9kZV8xX2RpdlwiICNlbFJlZjA+XG4gICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiVEFSR0VUICE9PSAncmVhY3ROYXRpdmUnXCI+XG4gICAgICAgIDxpbmxpbmVkLXN0eWxlc1xuICAgICAgICAgIGlkPVwiYnVpbGRlcmlvLWNvbHVtbnNcIlxuICAgICAgICAgIFtzdHlsZXNdPVwibm9kZV8yX0lubGluZWRTdHlsZXNcIlxuICAgICAgICAgIFtub25jZV09XCJidWlsZGVyQ29udGV4dC5ub25jZVwiXG4gICAgICAgID48L2lubGluZWQtc3R5bGVzPlxuICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgICA8bmctY29udGFpbmVyXG4gICAgICAgICpuZ0Zvcj1cImxldCBjb2x1bW4gb2YgY29sdW1uczsgaW5kZXggYXMgaW5kZXg7IHRyYWNrQnk6IHRyYWNrQnlDb2x1bW4wXCJcbiAgICAgID5cbiAgICAgICAgPGR5bmFtaWMtcmVuZGVyZXJcbiAgICAgICAgICBbVGFnTmFtZV09XCJub2RlXzNfRHluYW1pY1JlbmRlcmVyKGNvbHVtbiwgaW5kZXgpXCJcbiAgICAgICAgICBbYWN0aW9uQXR0cmlidXRlc109XCJub2RlXzRfRHluYW1pY1JlbmRlcmVyKGNvbHVtbiwgaW5kZXgpXCJcbiAgICAgICAgICBbYXR0cmlidXRlc109XCJub2RlXzVfRHluYW1pY1JlbmRlcmVyKGNvbHVtbiwgaW5kZXgpXCJcbiAgICAgICAgPlxuICAgICAgICAgIDxibG9ja3NcbiAgICAgICAgICAgIFtwYXRoXT1cIm5vZGVfNl9CbG9ja3MoY29sdW1uLCBpbmRleClcIlxuICAgICAgICAgICAgW3BhcmVudF09XCJidWlsZGVyQmxvY2suaWRcIlxuICAgICAgICAgICAgW2NvbnRleHRdPVwiYnVpbGRlckNvbnRleHRcIlxuICAgICAgICAgICAgW3JlZ2lzdGVyZWRDb21wb25lbnRzXT1cImJ1aWxkZXJDb21wb25lbnRzXCJcbiAgICAgICAgICAgIFtsaW5rQ29tcG9uZW50XT1cImJ1aWxkZXJMaW5rQ29tcG9uZW50XCJcbiAgICAgICAgICAgIFtibG9ja3NdPVwiY29sdW1uLmJsb2Nrc1wiXG4gICAgICAgICAgICBbc3R5bGVQcm9wXT1cIm5vZGVfN19CbG9ja3MoY29sdW1uLCBpbmRleClcIlxuICAgICAgICAgID48L2Jsb2Nrcz5cbiAgICAgICAgPC9keW5hbWljLXJlbmRlcmVyPlxuICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgPC9kaXY+XG4gIGAsXG4gIHN0eWxlczogW1xuICAgIGBcbiAgICAgIDpob3N0IHtcbiAgICAgICAgZGlzcGxheTogY29udGVudHM7XG4gICAgICB9XG4gICAgICAuZGl2IHtcbiAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgbGluZS1oZWlnaHQ6IG5vcm1hbDtcbiAgICAgIH1cbiAgICBgLFxuICBdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxuICBpbXBvcnRzOiBbQ29tbW9uTW9kdWxlLCBJbmxpbmVkU3R5bGVzLCBEeW5hbWljUmVuZGVyZXIsIEJsb2Nrc10sXG59KVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29sdW1ucyB7XG4gIFRBUkdFVCA9IFRBUkdFVDtcblxuICBASW5wdXQoKSBidWlsZGVyQmxvY2shOiBDb2x1bW5Qcm9wc1tcImJ1aWxkZXJCbG9ja1wiXTtcbiAgQElucHV0KCkgc3BhY2UhOiBDb2x1bW5Qcm9wc1tcInNwYWNlXCJdO1xuICBASW5wdXQoKSBjb2x1bW5zITogQ29sdW1uUHJvcHNbXCJjb2x1bW5zXCJdO1xuICBASW5wdXQoKSBzdGFja0NvbHVtbnNBdCE6IENvbHVtblByb3BzW1wic3RhY2tDb2x1bW5zQXRcIl07XG4gIEBJbnB1dCgpIGJ1aWxkZXJMaW5rQ29tcG9uZW50ITogQ29sdW1uUHJvcHNbXCJidWlsZGVyTGlua0NvbXBvbmVudFwiXTtcbiAgQElucHV0KCkgcmV2ZXJzZUNvbHVtbnNXaGVuU3RhY2tlZCE6IENvbHVtblByb3BzW1wicmV2ZXJzZUNvbHVtbnNXaGVuU3RhY2tlZFwiXTtcbiAgQElucHV0KCkgYnVpbGRlckNvbnRleHQhOiBDb2x1bW5Qcm9wc1tcImJ1aWxkZXJDb250ZXh0XCJdO1xuICBASW5wdXQoKSBidWlsZGVyQ29tcG9uZW50cyE6IENvbHVtblByb3BzW1wiYnVpbGRlckNvbXBvbmVudHNcIl07XG5cbiAgQFZpZXdDaGlsZChcImVsUmVmMFwiKSBlbFJlZjAhOiBFbGVtZW50UmVmO1xuXG4gIF9saXN0ZW5lckZucyA9IG5ldyBNYXA8c3RyaW5nLCAoKSA9PiB2b2lkPigpO1xuXG4gIGdldCBndXR0ZXJTaXplKCkge1xuICAgIHJldHVybiB0eXBlb2YgdGhpcy5zcGFjZSA9PT0gXCJudW1iZXJcIiA/IHRoaXMuc3BhY2UgfHwgMCA6IDIwO1xuICB9XG4gIGdldCBjb2xzKCkge1xuICAgIHJldHVybiB0aGlzLmNvbHVtbnMgfHwgW107XG4gIH1cbiAgZ2V0IHN0YWNrQXQoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhY2tDb2x1bW5zQXQgfHwgXCJ0YWJsZXRcIjtcbiAgfVxuICBnZXRUYWdOYW1lKGNvbHVtbjogQ29sdW1uKSB7XG4gICAgcmV0dXJuIGNvbHVtbi5saW5rID8gdGhpcy5idWlsZGVyTGlua0NvbXBvbmVudCB8fCBcImFcIiA6IER5bmFtaWNEaXY7XG4gIH1cbiAgZ2V0V2lkdGgoaW5kZXg6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmNvbHNbaW5kZXhdPy53aWR0aCB8fCAxMDAgLyB0aGlzLmNvbHMubGVuZ3RoO1xuICB9XG4gIGdldENvbHVtbkNzc1dpZHRoKGluZGV4OiBudW1iZXIpIHtcbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuZ2V0V2lkdGgoaW5kZXgpO1xuICAgIGNvbnN0IHN1YnRyYWN0V2lkdGggPVxuICAgICAgdGhpcy5ndXR0ZXJTaXplICogKHRoaXMuY29scy5sZW5ndGggLSAxKSAqICh3aWR0aCAvIDEwMCk7XG4gICAgcmV0dXJuIGBjYWxjKCR7d2lkdGh9JSAtICR7c3VidHJhY3RXaWR0aH1weClgO1xuICB9XG4gIGdldFRhYmxldFN0eWxlKHtcbiAgICBzdGFja2VkU3R5bGUsXG4gICAgZGVza3RvcFN0eWxlLFxuICB9OiB7XG4gICAgc3RhY2tlZFN0eWxlOiBDU1NWYWw7XG4gICAgZGVza3RvcFN0eWxlOiBDU1NWYWw7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5zdGFja0F0ID09PSBcInRhYmxldFwiID8gc3RhY2tlZFN0eWxlIDogZGVza3RvcFN0eWxlO1xuICB9XG4gIGdldE1vYmlsZVN0eWxlKHtcbiAgICBzdGFja2VkU3R5bGUsXG4gICAgZGVza3RvcFN0eWxlLFxuICB9OiB7XG4gICAgc3RhY2tlZFN0eWxlOiBDU1NWYWw7XG4gICAgZGVza3RvcFN0eWxlOiBDU1NWYWw7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5zdGFja0F0ID09PSBcIm5ldmVyXCIgPyBkZXNrdG9wU3R5bGUgOiBzdGFja2VkU3R5bGU7XG4gIH1cbiAgZ2V0IGZsZXhEaXIoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhY2tDb2x1bW5zQXQgPT09IFwibmV2ZXJcIlxuICAgICAgPyBcInJvd1wiXG4gICAgICA6IHRoaXMucmV2ZXJzZUNvbHVtbnNXaGVuU3RhY2tlZFxuICAgICAgPyBcImNvbHVtbi1yZXZlcnNlXCJcbiAgICAgIDogXCJjb2x1bW5cIjtcbiAgfVxuICBjb2x1bW5zQ3NzVmFycygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgXCItLWZsZXgtZGlyXCI6IHRoaXMuZmxleERpcixcbiAgICAgIFwiLS1mbGV4LWRpci10YWJsZXRcIjogdGhpcy5nZXRUYWJsZXRTdHlsZSh7XG4gICAgICAgIHN0YWNrZWRTdHlsZTogdGhpcy5mbGV4RGlyLFxuICAgICAgICBkZXNrdG9wU3R5bGU6IFwicm93XCIsXG4gICAgICB9KSxcbiAgICB9IGFzIERpY3Rpb25hcnk8c3RyaW5nPjtcbiAgfVxuICBjb2x1bW5Dc3NWYXJzKGluZGV4OiBudW1iZXIpIHtcbiAgICBjb25zdCBndXR0ZXIgPSBpbmRleCA9PT0gMCA/IDAgOiB0aGlzLmd1dHRlclNpemU7XG4gICAgY29uc3Qgd2lkdGggPSB0aGlzLmdldENvbHVtbkNzc1dpZHRoKGluZGV4KTtcbiAgICBjb25zdCBndXR0ZXJQaXhlbHMgPSBgJHtndXR0ZXJ9cHhgO1xuICAgIGNvbnN0IG1vYmlsZVdpZHRoID0gXCIxMDAlXCI7XG4gICAgY29uc3QgbW9iaWxlTWFyZ2luTGVmdCA9IDA7XG4gICAgY29uc3QgbWFyZ2luTGVmdEtleSA9IFwibWFyZ2luLWxlZnRcIjtcbiAgICBjb25zdCBzaGFyZWRTdHlsZXMgPSB7XG4gICAgICBkaXNwbGF5OiBcImZsZXhcIixcbiAgICAgIGZsZXhEaXJlY3Rpb246IFwiY29sdW1uXCIsXG4gICAgICBhbGlnbkl0ZW1zOiBcInN0cmV0Y2hcIixcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICAuLi5zaGFyZWRTdHlsZXMsXG4gICAgICB3aWR0aCxcbiAgICAgIFttYXJnaW5MZWZ0S2V5XTogZ3V0dGVyUGl4ZWxzLFxuICAgICAgXCItLWNvbHVtbi13aWR0aC1tb2JpbGVcIjogdGhpcy5nZXRNb2JpbGVTdHlsZSh7XG4gICAgICAgIHN0YWNrZWRTdHlsZTogbW9iaWxlV2lkdGgsXG4gICAgICAgIGRlc2t0b3BTdHlsZTogd2lkdGgsXG4gICAgICB9KSxcbiAgICAgIFwiLS1jb2x1bW4tbWFyZ2luLWxlZnQtbW9iaWxlXCI6IHRoaXMuZ2V0TW9iaWxlU3R5bGUoe1xuICAgICAgICBzdGFja2VkU3R5bGU6IG1vYmlsZU1hcmdpbkxlZnQsXG4gICAgICAgIGRlc2t0b3BTdHlsZTogZ3V0dGVyUGl4ZWxzLFxuICAgICAgfSksXG4gICAgICBcIi0tY29sdW1uLXdpZHRoLXRhYmxldFwiOiB0aGlzLmdldFRhYmxldFN0eWxlKHtcbiAgICAgICAgc3RhY2tlZFN0eWxlOiBtb2JpbGVXaWR0aCxcbiAgICAgICAgZGVza3RvcFN0eWxlOiB3aWR0aCxcbiAgICAgIH0pLFxuICAgICAgXCItLWNvbHVtbi1tYXJnaW4tbGVmdC10YWJsZXRcIjogdGhpcy5nZXRUYWJsZXRTdHlsZSh7XG4gICAgICAgIHN0YWNrZWRTdHlsZTogbW9iaWxlTWFyZ2luTGVmdCxcbiAgICAgICAgZGVza3RvcFN0eWxlOiBndXR0ZXJQaXhlbHMsXG4gICAgICB9KSxcbiAgICB9IGFzIERpY3Rpb25hcnk8c3RyaW5nPjtcbiAgfVxuICBnZXRXaWR0aEZvckJyZWFrcG9pbnRTaXplKHNpemU6IFNpemVOYW1lKSB7XG4gICAgY29uc3QgYnJlYWtwb2ludFNpemVzID0gZ2V0U2l6ZXNGb3JCcmVha3BvaW50cyhcbiAgICAgIHRoaXMuYnVpbGRlckNvbnRleHQuY29udGVudD8ubWV0YT8uYnJlYWtwb2ludHMgfHwge31cbiAgICApO1xuICAgIHJldHVybiBicmVha3BvaW50U2l6ZXNbc2l6ZV0ubWF4O1xuICB9XG4gIGNvbHVtbnNTdHlsZXMoKSB7XG4gICAgY29uc3QgY2hpbGRDb2x1bW5EaXYgPSBgLiR7dGhpcy5idWlsZGVyQmxvY2suaWR9LWJyZWFrcG9pbnRzIC5idWlsZGVyLWNvbHVtbjpmaXJzdC1vZi10eXBlYDtcbiAgICByZXR1cm4gYFxuICAgICAgICBAbWVkaWEgKG1heC13aWR0aDogJHt0aGlzLmdldFdpZHRoRm9yQnJlYWtwb2ludFNpemUoXCJtZWRpdW1cIil9cHgpIHtcbiAgICAgICAgICAuJHt0aGlzLmJ1aWxkZXJCbG9jay5pZH0tYnJlYWtwb2ludHMge1xuICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IHZhcigtLWZsZXgtZGlyLXRhYmxldCk7XG4gICAgICAgICAgICBhbGlnbi1pdGVtczogc3RyZXRjaDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAke2NoaWxkQ29sdW1uRGl2fSB7XG4gICAgICAgICAgICB3aWR0aDogdmFyKC0tY29sdW1uLXdpZHRoLXRhYmxldCkgIWltcG9ydGFudDtcbiAgICAgICAgICAgIG1hcmdpbi1sZWZ0OiB2YXIoLS1jb2x1bW4tbWFyZ2luLWxlZnQtdGFibGV0KSAhaW1wb3J0YW50O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIEBtZWRpYSAobWF4LXdpZHRoOiAke3RoaXMuZ2V0V2lkdGhGb3JCcmVha3BvaW50U2l6ZShcInNtYWxsXCIpfXB4KSB7XG4gICAgICAgICAgLiR7dGhpcy5idWlsZGVyQmxvY2suaWR9LWJyZWFrcG9pbnRzIHtcbiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiB2YXIoLS1mbGV4LWRpcik7XG4gICAgICAgICAgICBhbGlnbi1pdGVtczogc3RyZXRjaDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAke2NoaWxkQ29sdW1uRGl2fSB7XG4gICAgICAgICAgICB3aWR0aDogdmFyKC0tY29sdW1uLXdpZHRoLW1vYmlsZSkgIWltcG9ydGFudDtcbiAgICAgICAgICAgIG1hcmdpbi1sZWZ0OiB2YXIoLS1jb2x1bW4tbWFyZ2luLWxlZnQtbW9iaWxlKSAhaW1wb3J0YW50O1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIGA7XG4gIH1cbiAgZ2V0QXR0cmlidXRlcyhjb2x1bW46IGFueSwgaW5kZXg6IG51bWJlcikge1xuICAgIHJldHVybiB7XG4gICAgICAuLi57fSxcbiAgICAgIC4uLihjb2x1bW4ubGlua1xuICAgICAgICA/IHtcbiAgICAgICAgICAgIGhyZWY6IGNvbHVtbi5saW5rLFxuICAgICAgICAgIH1cbiAgICAgICAgOiB7fSksXG4gICAgICBbZ2V0Q2xhc3NQcm9wTmFtZSgpXTogXCJidWlsZGVyLWNvbHVtblwiLFxuICAgICAgc3R5bGU6IG1hcFN0eWxlT2JqVG9TdHJJZk5lZWRlZCh0aGlzLmNvbHVtbkNzc1ZhcnMoaW5kZXgpKSxcbiAgICB9O1xuICB9XG4gIG5vZGVfMF9kaXYgPSBudWxsO1xuICBub2RlXzFfZGl2ID0gbnVsbDtcbiAgbm9kZV8yX0lubGluZWRTdHlsZXMgPSBudWxsO1xuICBub2RlXzNfRHluYW1pY1JlbmRlcmVyID0gKGNvbHVtbiwgaW5kZXgpID0+IHRoaXMuZ2V0VGFnTmFtZShjb2x1bW4pO1xuICBub2RlXzRfRHluYW1pY1JlbmRlcmVyID0gKGNvbHVtbiwgaW5kZXgpID0+ICh7fSk7XG4gIG5vZGVfNV9EeW5hbWljUmVuZGVyZXIgPSAoY29sdW1uLCBpbmRleCkgPT4gdGhpcy5nZXRBdHRyaWJ1dGVzKGNvbHVtbiwgaW5kZXgpO1xuICBub2RlXzZfQmxvY2tzID0gKGNvbHVtbiwgaW5kZXgpID0+IGBjb2x1bW5zLiR7aW5kZXh9LmJsb2Nrc2A7XG4gIG5vZGVfN19CbG9ja3MgPSAoY29sdW1uLCBpbmRleCkgPT4gKHtcbiAgICBmbGV4R3JvdzogXCIxXCIsXG4gIH0pO1xuICBlbFJlZjBfc3RhdGVfMCA9IG51bGw7XG4gIHNldEF0dHJpYnV0ZXMoZWw6IEhUTUxFbGVtZW50LCB2YWx1ZTogYW55LCBjaGFuZ2VzPzogYW55KSB7XG4gICAgaWYgKCFlbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB0YXJnZXQgPSB0eXBlb2YgY2hhbmdlcyA9PT0gXCJ1bmRlZmluZWRcIiA/IHZhbHVlIDogY2hhbmdlcztcbiAgICBPYmplY3Qua2V5cyh0YXJnZXQpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKGtleS5zdGFydHNXaXRoKFwib25cIikpIHtcbiAgICAgICAgaWYgKHRoaXMuX2xpc3RlbmVyRm5zLmhhcyhrZXkpKSB7XG4gICAgICAgICAgdGhpcy5fbGlzdGVuZXJGbnMuZ2V0KGtleSkhKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fbGlzdGVuZXJGbnMuc2V0KFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihcbiAgICAgICAgICAgIGVsLFxuICAgICAgICAgICAga2V5LnJlcGxhY2UoXCJvblwiLCBcIlwiKS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgdGFyZ2V0W2tleV1cbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShlbCwga2V5LnRvTG93ZXJDYXNlKCksIHRhcmdldFtrZXldID8/IFwiXCIpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIHRyYWNrQnlDb2x1bW4wKGluZGV4LCBjb2x1bW4pIHtcbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5ub2RlXzBfZGl2ID0gZ2V0Q29sdW1uc0NsYXNzKHRoaXMuYnVpbGRlckJsb2NrPy5pZCk7XG4gICAgdGhpcy5ub2RlXzFfZGl2ID0gdGhpcy5jb2x1bW5zQ3NzVmFycygpO1xuICAgIHRoaXMubm9kZV8yX0lubGluZWRTdHlsZXMgPSB0aGlzLmNvbHVtbnNTdHlsZXMoKTtcbiAgICB0aGlzLmVsUmVmMF9zdGF0ZV8wID0ge307XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5zZXRBdHRyaWJ1dGVzKHRoaXMuZWxSZWYwPy5uYXRpdmVFbGVtZW50LCB0aGlzLmVsUmVmMF9zdGF0ZV8wKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdGhpcy5ub2RlXzBfZGl2ID0gZ2V0Q29sdW1uc0NsYXNzKHRoaXMuYnVpbGRlckJsb2NrPy5pZCk7XG4gICAgICB0aGlzLm5vZGVfMV9kaXYgPSB0aGlzLmNvbHVtbnNDc3NWYXJzKCk7XG4gICAgICB0aGlzLm5vZGVfMl9JbmxpbmVkU3R5bGVzID0gdGhpcy5jb2x1bW5zU3R5bGVzKCk7XG4gICAgICB0aGlzLmVsUmVmMF9zdGF0ZV8wID0ge307XG4gICAgICB0aGlzLnNldEF0dHJpYnV0ZXMoXG4gICAgICAgIHRoaXMuZWxSZWYwPy5uYXRpdmVFbGVtZW50LFxuICAgICAgICB0aGlzLmVsUmVmMF9zdGF0ZV8wLFxuICAgICAgICBjaGFuZ2VzW1wiZWxSZWYwX3N0YXRlXzBcIl0/LmN1cnJlbnRWYWx1ZVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBmb3IgKGNvbnN0IGZuIG9mIHRoaXMuX2xpc3RlbmVyRm5zLnZhbHVlcygpKSB7XG4gICAgICBmbigpO1xuICAgIH1cbiAgfVxufVxuIl19