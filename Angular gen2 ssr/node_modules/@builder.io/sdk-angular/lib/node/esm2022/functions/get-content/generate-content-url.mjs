import { flatten, flattenMongoQuery, unflatten } from '../../helpers/flatten';
import { normalizeSearchParams } from '../../helpers/search/search';
import { DEFAULT_API_VERSION } from '../../types/api-version';
import { getBuilderSearchParamsFromWindow } from '../get-builder-search-params/index';
import { isBrowser } from '../is-browser';
const isPositiveNumber = (thing) => typeof thing === 'number' && !isNaN(thing) && thing >= 0;
export const generateContentUrl = (options) => {
    const { limit = 30, userAttributes, query, model, apiKey, enrich, locale, apiVersion = DEFAULT_API_VERSION, fields, omit, offset, cacheSeconds, staleCacheSeconds, sort, includeUnpublished, apiHost } = options;
    if (!apiKey) {
        throw new Error('Missing API key');
    }
    if (!['v3'].includes(apiVersion)) {
        throw new Error(`Invalid apiVersion: expected 'v3', received '${apiVersion}'`);
    }
    // if we are fetching an array of content, we disable noTraverse for perf reasons.
    const noTraverse = limit !== 1;
    const baseUrl = apiHost || 'https://cdn.builder.io';
    const url = new URL(`${baseUrl}/api/${apiVersion}/content/${model}`);
    url.searchParams.set('apiKey', apiKey);
    url.searchParams.set('limit', String(limit));
    url.searchParams.set('noTraverse', String(noTraverse));
    url.searchParams.set('includeRefs', String(true));
    const finalLocale = locale || userAttributes?.locale;
    let finalUserAttributes = userAttributes || {};
    if (finalLocale) {
        url.searchParams.set('locale', finalLocale);
        finalUserAttributes = {
            locale: finalLocale,
            ...finalUserAttributes
        };
    }
    if (enrich)
        url.searchParams.set('enrich', String(enrich));
    url.searchParams.set('omit', omit || 'meta.componentsUsed');
    if (fields) {
        url.searchParams.set('fields', fields);
    }
    if (Number.isFinite(offset) && offset > -1) {
        url.searchParams.set('offset', String(Math.floor(offset)));
    }
    if (typeof includeUnpublished === 'boolean') {
        url.searchParams.set('includeUnpublished', String(includeUnpublished));
    }
    if (cacheSeconds && isPositiveNumber(cacheSeconds)) {
        url.searchParams.set('cacheSeconds', String(cacheSeconds));
    }
    if (staleCacheSeconds && isPositiveNumber(staleCacheSeconds)) {
        url.searchParams.set('staleCacheSeconds', String(staleCacheSeconds));
    }
    if (sort) {
        const flattened = flatten({
            sort
        });
        for (const key in flattened) {
            url.searchParams.set(key, JSON.stringify(flattened[key]));
        }
    }
    // TODO: how to express 'offset' in the url - as direct queryparam or as flattened in options[key] ?
    const queryOptions = {
        ...getBuilderSearchParamsFromWindow(),
        ...normalizeSearchParams(options.options || {})
    };
    finalUserAttributes = {
        ...finalUserAttributes,
        ...getUserAttributesAsJSON(queryOptions)
    };
    const flattened = flatten(queryOptions);
    for (const key in flattened) {
        url.searchParams.set(key, String(flattened[key]));
    }
    if (Object.keys(finalUserAttributes).length > 0) {
        url.searchParams.set('userAttributes', JSON.stringify(finalUserAttributes));
    }
    if (query) {
        const flattened = flattenMongoQuery({
            query
        });
        for (const key in flattened) {
            url.searchParams.set(key, JSON.stringify(flattened[key]));
        }
    }
    return url;
};
const getUserAttributesFromQueryOptions = (queryOptions) => {
    const newUserAttributes = {};
    for (const key in queryOptions) {
        if (key.startsWith('userAttributes.')) {
            newUserAttributes[key] = queryOptions[key];
            delete queryOptions[key];
        }
    }
    return newUserAttributes;
};
const getUserAttributesAsJSON = (queryOptions) => {
    if (isBrowser() && queryOptions['preview'] === 'BUILDER_STUDIO') {
        queryOptions['userAttributes.urlPath'] = window.location.pathname;
        queryOptions['userAttributes.host'] = window.location.host;
        const queryOptionsForUserAttributes = getUserAttributesFromQueryOptions(queryOptions);
        const { userAttributes } = unflatten(queryOptionsForUserAttributes);
        return userAttributes;
    }
    return {};
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtY29udGVudC11cmwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnVuY3Rpb25zL2dldC1jb250ZW50L2dlbmVyYXRlLWNvbnRlbnQtdXJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDcEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDdEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUxQyxNQUFNLGdCQUFnQixHQUFHLENBQUMsS0FBYyxFQUFFLEVBQUUsQ0FBQyxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FBQztBQUN0RyxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLE9BQTBCLEVBQU8sRUFBRTtJQUNwRSxNQUFNLEVBQ0osS0FBSyxHQUFHLEVBQUUsRUFDVixjQUFjLEVBQ2QsS0FBSyxFQUNMLEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUNOLE1BQU0sRUFDTixVQUFVLEdBQUcsbUJBQW1CLEVBQ2hDLE1BQU0sRUFDTixJQUFJLEVBQ0osTUFBTSxFQUNOLFlBQVksRUFDWixpQkFBaUIsRUFDakIsSUFBSSxFQUNKLGtCQUFrQixFQUNsQixPQUFPLEVBQ1IsR0FBRyxPQUFPLENBQUM7SUFDWixJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0tBQ3BDO0lBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxD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TSxpQkFBaUIsR0FBUSxFQUFFLENBQUM7SUFDbEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxZQUFZLEVBQUU7UUFDOUIsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLEVBQUU7WUFDckMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLE9BQU8sWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzFCO0tBQ0Y7SUFDRCxPQUFPLGlCQUFpQixDQUFDO0FBQzNCLENBQUMsQ0FBQztBQUNGLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxZQUFpQixFQUFFLEVBQUU7SUFDcEQsSUFBSSxTQUFTLEVBQUUsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssZ0JBQWdCLEVBQUU7UUFDL0QsWUFBWSxDQUFDLHdCQUF3QixDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDbEUsWUFBWSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDM0QsTUFBTSw2QkFBNkIsR0FBRyxpQ0FBaUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN0RixNQUFNLEVBQ0osY0FBYyxFQUNmLEdBQUcsU0FBUyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDN0MsT0FBTyxjQUFjLENBQUM7S0FDdkI7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZsYXR0ZW4sIGZsYXR0ZW5Nb25nb1F1ZXJ5LCB1bmZsYXR0ZW4gfSBmcm9tICcuLi8uLi9oZWxwZXJzL2ZsYXR0ZW4nO1xuaW1wb3J0IHsgbm9ybWFsaXplU2VhcmNoUGFyYW1zIH0gZnJvbSAnLi4vLi4vaGVscGVycy9zZWFyY2gvc2VhcmNoJztcbmltcG9ydCB7IERFRkFVTFRfQVBJX1ZFUlNJT04gfSBmcm9tICcuLi8uLi90eXBlcy9hcGktdmVyc2lvbic7XG5pbXBvcnQgeyBnZXRCdWlsZGVyU2VhcmNoUGFyYW1zRnJvbVdpbmRvdyB9IGZyb20gJy4uL2dldC1idWlsZGVyLXNlYXJjaC1wYXJhbXMvaW5kZXgnO1xuaW1wb3J0IHsgaXNCcm93c2VyIH0gZnJvbSAnLi4vaXMtYnJvd3Nlcic7XG5pbXBvcnQgdHlwZSB7IEdldENvbnRlbnRPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5jb25zdCBpc1Bvc2l0aXZlTnVtYmVyID0gKHRoaW5nOiB1bmtub3duKSA9PiB0eXBlb2YgdGhpbmcgPT09ICdudW1iZXInICYmICFpc05hTih0aGluZykgJiYgdGhpbmcgPj0gMDtcbmV4cG9ydCBjb25zdCBnZW5lcmF0ZUNvbnRlbnRVcmwgPSAob3B0aW9uczogR2V0Q29udGVudE9wdGlvbnMpOiBVUkwgPT4ge1xuICBjb25zdCB7XG4gICAgbGltaXQgPSAzMCxcbiAgICB1c2VyQXR0cmlidXRlcyxcbiAgICBxdWVyeSxcbiAgICBtb2RlbCxcbiAgICBhcGlLZXksXG4gICAgZW5yaWNoLFxuICAgIGxvY2FsZSxcbiAgICBhcGlWZXJzaW9uID0gREVGQVVMVF9BUElfVkVSU0lPTixcbiAgICBmaWVsZHMsXG4gICAgb21pdCxcbiAgICBvZmZzZXQsXG4gICAgY2FjaGVTZWNvbmRzLFxuICAgIHN0YWxlQ2FjaGVTZWNvbmRzLFxuICAgIHNvcnQsXG4gICAgaW5jbHVkZVVucHVibGlzaGVkLFxuICAgIGFwaUhvc3RcbiAgfSA9IG9wdGlvbnM7XG4gIGlmICghYXBpS2V5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIEFQSSBrZXknKTtcbiAgfVxuICBpZiAoIVsndjMnXS5pbmNsdWRlcyhhcGlWZXJzaW9uKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhcGlWZXJzaW9uOiBleHBlY3RlZCAndjMnLCByZWNlaXZlZCAnJHthcGlWZXJzaW9ufSdgKTtcbiAgfVxuXG4gIC8vIGlmIHdlIGFyZSBmZXRjaGluZyBhbiBhcnJheSBvZiBjb250ZW50LCB3ZSBkaXNhYmxlIG5vVHJhdmVyc2UgZm9yIHBlcmYgcmVhc29ucy5cbiAgY29uc3Qgbm9UcmF2ZXJzZSA9IGxpbWl0ICE9PSAxO1xuICBjb25zdCBiYXNlVXJsID0gYXBpSG9zdCB8fCAnaHR0cHM6Ly9jZG4uYnVpbGRlci5pbyc7XG4gIGNvbnN0IHVybCA9IG5ldyBVUkwoYCR7YmFzZVVybH0vYXBpLyR7YXBpVmVyc2lvbn0vY29udGVudC8ke21vZGVsfWApO1xuICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnYXBpS2V5JywgYXBpS2V5KTtcbiAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2xpbWl0JywgU3RyaW5nKGxpbWl0KSk7XG4gIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdub1RyYXZlcnNlJywgU3RyaW5nKG5vVHJhdmVyc2UpKTtcbiAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2luY2x1ZGVSZWZzJywgU3RyaW5nKHRydWUpKTtcbiAgY29uc3QgZmluYWxMb2NhbGUgPSBsb2NhbGUgfHwgdXNlckF0dHJpYnV0ZXM/LmxvY2FsZTtcbiAgbGV0IGZpbmFsVXNlckF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB1c2VyQXR0cmlidXRlcyB8fCB7fTtcbiAgaWYgKGZpbmFsTG9jYWxlKSB7XG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2xvY2FsZScsIGZpbmFsTG9jYWxlKTtcbiAgICBmaW5hbFVzZXJBdHRyaWJ1dGVzID0ge1xuICAgICAgbG9jYWxlOiBmaW5hbExvY2FsZSxcbiAgICAgIC4uLmZpbmFsVXNlckF0dHJpYnV0ZXNcbiAgICB9O1xuICB9XG4gIGlmIChlbnJpY2gpIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdlbnJpY2gnLCBTdHJpbmcoZW5yaWNoKSk7XG4gIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdvbWl0Jywgb21pdCB8fCAnbWV0YS5jb21wb25lbnRzVXNlZCcpO1xuICBpZiAoZmllbGRzKSB7XG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2ZpZWxkcycsIGZpZWxkcyk7XG4gIH1cbiAgaWYgKE51bWJlci5pc0Zpbml0ZShvZmZzZXQpICYmIG9mZnNldCEgPiAtMSkge1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdvZmZzZXQnLCBTdHJpbmcoTWF0aC5mbG9vcihvZmZzZXQhKSkpO1xuICB9XG4gIGlmICh0eXBlb2YgaW5jbHVkZVVucHVibGlzaGVkID09PSAnYm9vbGVhbicpIHtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnaW5jbHVkZVVucHVibGlzaGVkJywgU3RyaW5nKGluY2x1ZGVVbnB1Ymxpc2hlZCkpO1xuICB9XG4gIGlmIChjYWNoZVNlY29uZHMgJiYgaXNQb3NpdGl2ZU51bWJlcihjYWNoZVNlY29uZHMpKSB7XG4gICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2NhY2hlU2Vjb25kcycsIFN0cmluZyhjYWNoZVNlY29uZHMpKTtcbiAgfVxuICBpZiAoc3RhbGVDYWNoZVNlY29uZHMgJiYgaXNQb3NpdGl2ZU51bWJlcihzdGFsZUNhY2hlU2Vjb25kcykpIHtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3RhbGVDYWNoZVNlY29uZHMnLCBTdHJpbmcoc3RhbGVDYWNoZVNlY29uZHMpKTtcbiAgfVxuICBpZiAoc29ydCkge1xuICAgIGNvbnN0IGZsYXR0ZW5lZCA9IGZsYXR0ZW4oe1xuICAgICAgc29ydFxuICAgIH0pO1xuICAgIGZvciAoY29uc3Qga2V5IGluIGZsYXR0ZW5lZCkge1xuICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5LCBKU09OLnN0cmluZ2lmeSgoZmxhdHRlbmVkIGFzIGFueSlba2V5XSkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRPRE86IGhvdyB0byBleHByZXNzICdvZmZzZXQnIGluIHRoZSB1cmwgLSBhcyBkaXJlY3QgcXVlcnlwYXJhbSBvciBhcyBmbGF0dGVuZWQgaW4gb3B0aW9uc1trZXldID9cblxuICBjb25zdCBxdWVyeU9wdGlvbnMgPSB7XG4gICAgLi4uZ2V0QnVpbGRlclNlYXJjaFBhcmFtc0Zyb21XaW5kb3coKSxcbiAgICAuLi5ub3JtYWxpemVTZWFyY2hQYXJhbXMob3B0aW9ucy5vcHRpb25zIHx8IHt9KVxuICB9O1xuICBmaW5hbFVzZXJBdHRyaWJ1dGVzID0ge1xuICAgIC4uLmZpbmFsVXNlckF0dHJpYnV0ZXMsXG4gICAgLi4uZ2V0VXNlckF0dHJpYnV0ZXNBc0pTT04ocXVlcnlPcHRpb25zKVxuICB9O1xuICBjb25zdCBmbGF0dGVuZWQgPSBmbGF0dGVuKHF1ZXJ5T3B0aW9ucyk7XG4gIGZvciAoY29uc3Qga2V5IGluIGZsYXR0ZW5lZCkge1xuICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KGtleSwgU3RyaW5nKGZsYXR0ZW5lZFtrZXldKSk7XG4gIH1cbiAgaWYgKE9iamVjdC5rZXlzKGZpbmFsVXNlckF0dHJpYnV0ZXMpLmxlbmd0aCA+IDApIHtcbiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgndXNlckF0dHJpYnV0ZXMnLCBKU09OLnN0cmluZ2lmeShmaW5hbFVzZXJBdHRyaWJ1dGVzKSk7XG4gIH1cbiAgaWYgKHF1ZXJ5KSB7XG4gICAgY29uc3QgZmxhdHRlbmVkID0gZmxhdHRlbk1vbmdvUXVlcnkoe1xuICAgICAgcXVlcnlcbiAgICB9KTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBmbGF0dGVuZWQpIHtcbiAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KGtleSwgSlNPTi5zdHJpbmdpZnkoZmxhdHRlbmVkW2tleV0pKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVybDtcbn07XG5jb25zdCBnZXRVc2VyQXR0cmlidXRlc0Zyb21RdWVyeU9wdGlvbnMgPSAocXVlcnlPcHRpb25zOiBhbnkpID0+IHtcbiAgY29uc3QgbmV3VXNlckF0dHJpYnV0ZXM6IGFueSA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBpbiBxdWVyeU9wdGlvbnMpIHtcbiAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ3VzZXJBdHRyaWJ1dGVzLicpKSB7XG4gICAgICBuZXdVc2VyQXR0cmlidXRlc1trZXldID0gcXVlcnlPcHRpb25zW2tleV07XG4gICAgICBkZWxldGUgcXVlcnlPcHRpb25zW2tleV07XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXdVc2VyQXR0cmlidXRlcztcbn07XG5jb25zdCBnZXRVc2VyQXR0cmlidXRlc0FzSlNPTiA9IChxdWVyeU9wdGlvbnM6IGFueSkgPT4ge1xuICBpZiAoaXNCcm93c2VyKCkgJiYgcXVlcnlPcHRpb25zWydwcmV2aWV3J10gPT09ICdCVUlMREVSX1NUVURJTycpIHtcbiAgICBxdWVyeU9wdGlvbnNbJ3VzZXJBdHRyaWJ1dGVzLnVybFBhdGgnXSA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTtcbiAgICBxdWVyeU9wdGlvbnNbJ3VzZXJBdHRyaWJ1dGVzLmhvc3QnXSA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0O1xuICAgIGNvbnN0IHF1ZXJ5T3B0aW9uc0ZvclVzZXJBdHRyaWJ1dGVzID0gZ2V0VXNlckF0dHJpYnV0ZXNGcm9tUXVlcnlPcHRpb25zKHF1ZXJ5T3B0aW9ucyk7XG4gICAgY29uc3Qge1xuICAgICAgdXNlckF0dHJpYnV0ZXNcbiAgICB9ID0gdW5mbGF0dGVuKHF1ZXJ5T3B0aW9uc0ZvclVzZXJBdHRyaWJ1dGVzKTtcbiAgICByZXR1cm4gdXNlckF0dHJpYnV0ZXM7XG4gIH1cbiAgcmV0dXJuIHt9O1xufSJdfQ==