import { TARGET } from '../../constants/target';
import { handleABTesting } from '../../helpers/ab-tests';
import { getDefaultCanTrack } from '../../helpers/canTrack';
import { logger } from '../../helpers/logger';
import { getPreviewContent } from '../../helpers/preview-lru-cache/get';
import { getSdkHeaders } from '../../helpers/sdk-headers';
import { fetch } from '../get-fetch';
import { isBrowser } from '../is-browser';
import { generateContentUrl } from './generate-content-url';
const checkContentHasResults = (content) => 'results' in content;
/**
 * Returns the first content entry that matches the given options.
 */
export async function fetchOneEntry(options) {
    const allContent = await fetchEntries({
        ...options,
        limit: 1
    });
    if (allContent) {
        return allContent[0] || null;
    }
    return null;
}
const _fetchContent = async (options) => {
    const url = generateContentUrl(options);
    const _fetch = options.fetch ?? fetch;
    const fetchOptions = {
        ...options.fetchOptions,
        headers: {
            ...options.fetchOptions?.headers,
            ...getSdkHeaders()
        }
    };
    const res = await _fetch(url.href, fetchOptions);
    const content = await res.json();
    return content;
};
/**
 * @internal Exported only for testing purposes. Do not use.
 */
export const _processContentResult = async (options, content, url = generateContentUrl(options)) => {
    const canTrack = getDefaultCanTrack(options.canTrack);
    const isPreviewing = url.search.includes(`preview=`);
    if (TARGET === 'rsc' && isPreviewing) {
        const newResults = [];
        for (const item of content.results) {
            const previewContent = getPreviewContent(url.searchParams);
            newResults.push(previewContent || item);
        }
        content.results = newResults;
    }
    if (!canTrack)
        return content.results;
    if (!(isBrowser() || TARGET === 'reactNative'))
        return content.results;
    /**
     * For client-side navigations, it is ideal to handle AB testing at this point instead of using our
     * complex multi-rendering variants approach, which is only needed for SSR'd content.
     *
     * This is also where react-native would handle AB testing.
     */
    try {
        const newResults = [];
        for (const item of content.results) {
            newResults.push(await handleABTesting({
                item,
                canTrack
            }));
        }
        content.results = newResults;
    }
    catch (e) {
        logger.error('Could not process A/B tests. ', e);
    }
    return content.results;
};
/**
 * Returns a paginated array of entries that match the given options.
 */
export async function fetchEntries(options) {
    const url = generateContentUrl(options);
    const content = await _fetchContent(options);
    if (!checkContentHasResults(content)) {
        logger.error('Error fetching data. ', {
            url,
            content,
            options
        });
        throw content;
    }
    return _processContentResult(options, content);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvZnVuY3Rpb25zL2dldC1jb250ZW50L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDekQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUUxRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFNUQsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLE9BQXdCLEVBQTZCLEVBQUUsQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDO0FBRTdHOztHQUVHO0FBQ0gsTUFBTSxDQUFDLEtBQUssVUFBVSxhQUFhLENBQUMsT0FBMEI7SUFDNUQsTUFBTSxVQUFVLEdBQUcsTUFBTSxZQUFZLENBQUM7UUFDcEMsR0FBRyxPQUFPO1FBQ1YsS0FBSyxFQUFFLENBQUM7S0FDVCxDQUFDLENBQUM7SUFDSCxJQUFJLFVBQVUsRUFBRTtRQUNkLE9BQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztLQUM5QjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQVFELE1BQU0sYUFBYSxHQUFHLEtBQUssRUFBRSxPQUEwQixFQUFFLEVBQUU7SUFDekQsTUFBTSxHQUFHLEdBQUcsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUM7SUFDdEMsTUFBTSxZQUFZLEdBQUc7UUFDbkIsR0FBRyxPQUFPLENBQUMsWUFBWTtRQUN2QixPQUFPLEVBQUU7WUFDUCxHQUFJLE9BQU8sQ0FBQyxZQUFvQixFQUFFLE9BQU87WUFDekMsR0FBRyxhQUFhLEVBQUU7U0FDbkI7S0FDRixDQUFDO0lBQ0YsTUFBTSxHQUFHLEdBQUcsTUFBTSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNqRCxNQUFNLE9BQU8sR0FBRyxNQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQStCLENBQUM7SUFDL0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLEVBQUUsT0FBMEIsRUFBRSxPQUF1QixFQUFFLE1BQVcsa0JBQWtCLENBQUMsT0FBTyxDQUFDLEVBQTZCLEVBQUU7SUFDcEssTUFBTSxRQUFRLEdBQUcsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3RELE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3JELElBQUksTUFBTSxLQUFLLEtBQUssSUFBSSxZQUFZLEVBQUU7UUFDcEMsTUFBTSxVQUFVLEdBQXFCLEVBQUUsQ0FBQztRQUN4QyxLQUFLLE1BQU0sSUFBSSxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUU7WUFDbEMsTUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzNELFVBQVUsQ0FBQyxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxDQUFDO1NBQ3pDO1FBQ0QsT0FBTyxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUM7S0FDOUI7SUFDRCxJQUFJLENBQUMsUUFBUTtRQUFFLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQztJQUN0QyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxNQUFNLEtBQUssYUFBYSxDQUFDO1FBQUUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDO0lBRXZFOzs7OztPQUtHO0lBQ0gsSUFBSTtRQUNGLE1BQU0sVUFBVSxHQUFxQixFQUFFLENBQUM7UUFDeEMsS0FBSyxNQUFNLElBQUksSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQ2xDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxlQUFlLENBQUM7Z0JBQ3BDLElBQUk7Z0JBQ0osUUFBUTthQUNULENBQUMsQ0FBQyxDQUFDO1NBQ0w7UUFDRCxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQztLQUM5QjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1YsTUFBTSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxDQUFDLENBQUMsQ0FBQztLQUNsRDtJQUNELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQztBQUN6QixDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsWUFBWSxDQUFDLE9BQTBCO0lBQzNELE1BQU0sR0FBRyxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sT0FBTyxHQUFHLE1BQU0sYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFO1lBQ3BDLEdBQUc7WUFDSCxPQUFPO1lBQ1AsT0FBTztTQUNSLENBQUMsQ0FBQztRQUNILE1BQU0sT0FBTyxDQUFDO0tBQ2Y7SUFDRCxPQUFPLHFCQUFxQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNqRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVEFSR0VUIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzL3RhcmdldCc7XG5pbXBvcnQgeyBoYW5kbGVBQlRlc3RpbmcgfSBmcm9tICcuLi8uLi9oZWxwZXJzL2FiLXRlc3RzJztcbmltcG9ydCB7IGdldERlZmF1bHRDYW5UcmFjayB9IGZyb20gJy4uLy4uL2hlbHBlcnMvY2FuVHJhY2snO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vaGVscGVycy9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0UHJldmlld0NvbnRlbnQgfSBmcm9tICcuLi8uLi9oZWxwZXJzL3ByZXZpZXctbHJ1LWNhY2hlL2dldCc7XG5pbXBvcnQgeyBnZXRTZGtIZWFkZXJzIH0gZnJvbSAnLi4vLi4vaGVscGVycy9zZGstaGVhZGVycyc7XG5pbXBvcnQgdHlwZSB7IEJ1aWxkZXJDb250ZW50IH0gZnJvbSAnLi4vLi4vdHlwZXMvYnVpbGRlci1jb250ZW50JztcbmltcG9ydCB7IGZldGNoIH0gZnJvbSAnLi4vZ2V0LWZldGNoJztcbmltcG9ydCB7IGlzQnJvd3NlciB9IGZyb20gJy4uL2lzLWJyb3dzZXInO1xuaW1wb3J0IHsgZ2VuZXJhdGVDb250ZW50VXJsIH0gZnJvbSAnLi9nZW5lcmF0ZS1jb250ZW50LXVybCc7XG5pbXBvcnQgdHlwZSB7IEdldENvbnRlbnRPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5jb25zdCBjaGVja0NvbnRlbnRIYXNSZXN1bHRzID0gKGNvbnRlbnQ6IENvbnRlbnRSZXNwb25zZSk6IGNvbnRlbnQgaXMgQ29udGVudFJlc3VsdHMgPT4gJ3Jlc3VsdHMnIGluIGNvbnRlbnQ7XG5cbi8qKlxuICogUmV0dXJucyB0aGUgZmlyc3QgY29udGVudCBlbnRyeSB0aGF0IG1hdGNoZXMgdGhlIGdpdmVuIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaE9uZUVudHJ5KG9wdGlvbnM6IEdldENvbnRlbnRPcHRpb25zKTogUHJvbWlzZTxCdWlsZGVyQ29udGVudCB8IG51bGw+IHtcbiAgY29uc3QgYWxsQ29udGVudCA9IGF3YWl0IGZldGNoRW50cmllcyh7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBsaW1pdDogMVxuICB9KTtcbiAgaWYgKGFsbENvbnRlbnQpIHtcbiAgICByZXR1cm4gYWxsQ29udGVudFswXSB8fCBudWxsO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxudHlwZSBDb250ZW50UmVzdWx0cyA9IHtcbiAgcmVzdWx0czogQnVpbGRlckNvbnRlbnRbXTtcbn07XG50eXBlIENvbnRlbnRSZXNwb25zZSA9IENvbnRlbnRSZXN1bHRzIHwge1xuICBzdGF0dXM6IG51bWJlcjtcbiAgbWVzc2FnZTogc3RyaW5nO1xufTtcbmNvbnN0IF9mZXRjaENvbnRlbnQgPSBhc3luYyAob3B0aW9uczogR2V0Q29udGVudE9wdGlvbnMpID0+IHtcbiAgY29uc3QgdXJsID0gZ2VuZXJhdGVDb250ZW50VXJsKG9wdGlvbnMpO1xuICBjb25zdCBfZmV0Y2ggPSBvcHRpb25zLmZldGNoID8/IGZldGNoO1xuICBjb25zdCBmZXRjaE9wdGlvbnMgPSB7XG4gICAgLi4ub3B0aW9ucy5mZXRjaE9wdGlvbnMsXG4gICAgaGVhZGVyczoge1xuICAgICAgLi4uKG9wdGlvbnMuZmV0Y2hPcHRpb25zIGFzIGFueSk/LmhlYWRlcnMsXG4gICAgICAuLi5nZXRTZGtIZWFkZXJzKClcbiAgICB9XG4gIH07XG4gIGNvbnN0IHJlcyA9IGF3YWl0IF9mZXRjaCh1cmwuaHJlZiwgZmV0Y2hPcHRpb25zKTtcbiAgY29uc3QgY29udGVudCA9IGF3YWl0IChyZXMuanNvbigpIGFzIFByb21pc2U8Q29udGVudFJlc3BvbnNlPik7XG4gIHJldHVybiBjb250ZW50O1xufTtcblxuLyoqXG4gKiBAaW50ZXJuYWwgRXhwb3J0ZWQgb25seSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4gRG8gbm90IHVzZS5cbiAqL1xuZXhwb3J0IGNvbnN0IF9wcm9jZXNzQ29udGVudFJlc3VsdCA9IGFzeW5jIChvcHRpb25zOiBHZXRDb250ZW50T3B0aW9ucywgY29udGVudDogQ29udGVudFJlc3VsdHMsIHVybDogVVJMID0gZ2VuZXJhdGVDb250ZW50VXJsKG9wdGlvbnMpKTogUHJvbWlzZTxCdWlsZGVyQ29udGVudFtdPiA9PiB7XG4gIGNvbnN0IGNhblRyYWNrID0gZ2V0RGVmYXVsdENhblRyYWNrKG9wdGlvbnMuY2FuVHJhY2spO1xuICBjb25zdCBpc1ByZXZpZXdpbmcgPSB1cmwuc2VhcmNoLmluY2x1ZGVzKGBwcmV2aWV3PWApO1xuICBpZiAoVEFSR0VUID09PSAncnNjJyAmJiBpc1ByZXZpZXdpbmcpIHtcbiAgICBjb25zdCBuZXdSZXN1bHRzOiBCdWlsZGVyQ29udGVudFtdID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGNvbnRlbnQucmVzdWx0cykge1xuICAgICAgY29uc3QgcHJldmlld0NvbnRlbnQgPSBnZXRQcmV2aWV3Q29udGVudCh1cmwuc2VhcmNoUGFyYW1zKTtcbiAgICAgIG5ld1Jlc3VsdHMucHVzaChwcmV2aWV3Q29udGVudCB8fCBpdGVtKTtcbiAgICB9XG4gICAgY29udGVudC5yZXN1bHRzID0gbmV3UmVzdWx0cztcbiAgfVxuICBpZiAoIWNhblRyYWNrKSByZXR1cm4gY29udGVudC5yZXN1bHRzO1xuICBpZiAoIShpc0Jyb3dzZXIoKSB8fCBUQVJHRVQgPT09ICdyZWFjdE5hdGl2ZScpKSByZXR1cm4gY29udGVudC5yZXN1bHRzO1xuXG4gIC8qKlxuICAgKiBGb3IgY2xpZW50LXNpZGUgbmF2aWdhdGlvbnMsIGl0IGlzIGlkZWFsIHRvIGhhbmRsZSBBQiB0ZXN0aW5nIGF0IHRoaXMgcG9pbnQgaW5zdGVhZCBvZiB1c2luZyBvdXJcbiAgICogY29tcGxleCBtdWx0aS1yZW5kZXJpbmcgdmFyaWFudHMgYXBwcm9hY2gsIHdoaWNoIGlzIG9ubHkgbmVlZGVkIGZvciBTU1InZCBjb250ZW50LlxuICAgKlxuICAgKiBUaGlzIGlzIGFsc28gd2hlcmUgcmVhY3QtbmF0aXZlIHdvdWxkIGhhbmRsZSBBQiB0ZXN0aW5nLlxuICAgKi9cbiAgdHJ5IHtcbiAgICBjb25zdCBuZXdSZXN1bHRzOiBCdWlsZGVyQ29udGVudFtdID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGNvbnRlbnQucmVzdWx0cykge1xuICAgICAgbmV3UmVzdWx0cy5wdXNoKGF3YWl0IGhhbmRsZUFCVGVzdGluZyh7XG4gICAgICAgIGl0ZW0sXG4gICAgICAgIGNhblRyYWNrXG4gICAgICB9KSk7XG4gICAgfVxuICAgIGNvbnRlbnQucmVzdWx0cyA9IG5ld1Jlc3VsdHM7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0NvdWxkIG5vdCBwcm9jZXNzIEEvQiB0ZXN0cy4gJywgZSk7XG4gIH1cbiAgcmV0dXJuIGNvbnRlbnQucmVzdWx0cztcbn07XG5cbi8qKlxuICogUmV0dXJucyBhIHBhZ2luYXRlZCBhcnJheSBvZiBlbnRyaWVzIHRoYXQgbWF0Y2ggdGhlIGdpdmVuIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaEVudHJpZXMob3B0aW9uczogR2V0Q29udGVudE9wdGlvbnMpIHtcbiAgY29uc3QgdXJsID0gZ2VuZXJhdGVDb250ZW50VXJsKG9wdGlvbnMpO1xuICBjb25zdCBjb250ZW50ID0gYXdhaXQgX2ZldGNoQ29udGVudChvcHRpb25zKTtcbiAgaWYgKCFjaGVja0NvbnRlbnRIYXNSZXN1bHRzKGNvbnRlbnQpKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBmZXRjaGluZyBkYXRhLiAnLCB7XG4gICAgICB1cmwsXG4gICAgICBjb250ZW50LFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuICAgIHRocm93IGNvbnRlbnQ7XG4gIH1cbiAgcmV0dXJuIF9wcm9jZXNzQ29udGVudFJlc3VsdChvcHRpb25zLCBjb250ZW50KTtcbn0iXX0=