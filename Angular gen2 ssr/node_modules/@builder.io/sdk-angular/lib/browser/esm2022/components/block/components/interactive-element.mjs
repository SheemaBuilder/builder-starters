import { reflectComponentType, Component, ViewChild, Input, } from "@angular/core";
import { CommonModule } from "@angular/common";
import { getBlockActions } from "../../../functions/get-block-actions";
import { getBlockProperties } from "../../../functions/get-block-properties";
import Awaiter from "../../awaiter";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export default class InteractiveElement {
    get attributes() {
        return this.includeBlockProps
            ? {
                ...getBlockProperties({
                    block: this.block,
                    context: this.context,
                }),
                ...getBlockActions({
                    block: this.block,
                    rootState: this.context.rootState,
                    rootSetState: this.context.rootSetState,
                    localState: this.context.localState,
                    context: this.context.context,
                }),
            }
            : {};
    }
    constructor(vcRef, renderer) {
        this.vcRef = vcRef;
        this.renderer = renderer;
        this.mergedInputs_atkjh2 = {};
        this._listenerFns = new Map();
    }
    ngOnInit() {
        this.mergedInputs_atkjh2 = {
            ...this.filterPropsThatWrapperNeeds(this.wrapperProps),
            ...(this.hasAttributesInput(this.Wrapper) ? { attributes: this.attributes } : {})
        };
        this.myContent = [
            this.vcRef.createEmbeddedView(this.wrapperTemplateRef).rootNodes,
        ];
    }
    hasAttributesInput(component) {
        return !!reflectComponentType(component)?.inputs.find(input => input.propName === 'attributes');
    }
    updateAttributes(el, attributes) {
        Object.keys(attributes).forEach((attr) => {
            if (attr.startsWith("on")) {
                if (this._listenerFns.has(attr)) {
                    this._listenerFns.get(attr)();
                }
                this._listenerFns.set(attr, this.renderer.listen(el, attr.replace("on", "").toLowerCase(), attributes[attr]));
            }
            else if (attr === 'class' && attributes[attr]) {
                const classes = attributes[attr].split(' ');
                classes.forEach((cls) => this.renderer.addClass(el, cls.trim()));
            }
            else {
                this.renderer.setAttribute(el, attr.toLowerCase(), attributes[attr] ?? "");
            }
        });
    }
    ngAfterViewInit() {
        if (!this.hasAttributesInput(this.Wrapper)) {
            const wrapperElement = this.wrapperTemplateRef.elementRef.nativeElement?.nextElementSibling;
            if (wrapperElement) {
                this.updateAttributes(wrapperElement, this.attributes);
            }
        }
    }
    ngOnDestroy() {
        for (const fn of this._listenerFns.values()) {
            fn();
        }
    }
    filterPropsThatWrapperNeeds(allProps) {
        const definedPropNames = reflectComponentType(this.Wrapper).inputs.map(prop => prop.propName);
        return definedPropNames.reduce((acc, propName) => {
            acc[propName] = allProps[propName];
            return acc;
        }, {});
    }
    ngOnChanges(changes) {
        if (changes["attributes"] && !this.hasAttributesInput(this.Wrapper)) {
            this.ngAfterViewInit();
        }
        if (typeof window !== "undefined") {
            this.mergedInputs_atkjh2 = {
                ...this.filterPropsThatWrapperNeeds(this.wrapperProps),
                ...(this.hasAttributesInput(this.Wrapper) ? { attributes: this.attributes } : {})
            };
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: InteractiveElement, deps: [{ token: i0.ViewContainerRef }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: InteractiveElement, isStandalone: true, selector: "interactive-element", inputs: { includeBlockProps: "includeBlockProps", block: "block", context: "context", Wrapper: "Wrapper", wrapperProps: "wrapperProps" }, viewQueries: [{ propertyName: "wrapperTemplateRef", first: true, predicate: ["wrapperTemplate"], descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: `
    <ng-template #wrapperTemplate><ng-content></ng-content></ng-template>
    <ng-container *ngIf="Wrapper.load">
      <awaiter
        [load]="Wrapper.load"
        [fallback]="Wrapper.fallback"
        [props]="wrapperProps"
        [attributes]="attributes"
      >
        <ng-content></ng-content>
      </awaiter>
    </ng-container>
    <ng-container *ngIf="!(Wrapper.load)">
      <ng-container
        *ngComponentOutlet="
              Wrapper;
              inputs: mergedInputs_atkjh2;
              content: myContent;
              "
      ></ng-container>
    </ng-container>
  `, isInline: true, styles: [":host{display:contents}\n"], dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgComponentOutlet, selector: "[ngComponentOutlet]", inputs: ["ngComponentOutlet", "ngComponentOutletInputs", "ngComponentOutletInjector", "ngComponentOutletContent", "ngComponentOutletNgModule", "ngComponentOutletNgModuleFactory"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: Awaiter, selector: "awaiter", inputs: ["load", "props", "attributes", "fallback"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: InteractiveElement, decorators: [{
            type: Component,
            args: [{ selector: "interactive-element", template: `
    <ng-template #wrapperTemplate><ng-content></ng-content></ng-template>
    <ng-container *ngIf="Wrapper.load">
      <awaiter
        [load]="Wrapper.load"
        [fallback]="Wrapper.fallback"
        [props]="wrapperProps"
        [attributes]="attributes"
      >
        <ng-content></ng-content>
      </awaiter>
    </ng-container>
    <ng-container *ngIf="!(Wrapper.load)">
      <ng-container
        *ngComponentOutlet="
              Wrapper;
              inputs: mergedInputs_atkjh2;
              content: myContent;
              "
      ></ng-container>
    </ng-container>
  `, standalone: true, imports: [CommonModule, Awaiter], styles: [":host{display:contents}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }, { type: i0.Renderer2 }]; }, propDecorators: { includeBlockProps: [{
                type: Input
            }], block: [{
                type: Input
            }], context: [{
                type: Input
            }], Wrapper: [{
                type: Input
            }], wrapperProps: [{
                type: Input
            }], wrapperTemplateRef: [{
                type: ViewChild,
                args: ["wrapperTemplate", { static: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJhY3RpdmUtZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Jsb2NrL2NvbXBvbmVudHMvaW50ZXJhY3RpdmUtZWxlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUcsb0JBQW9CLEVBRTVCLFNBQVMsRUFDVCxTQUFTLEVBRVQsS0FBSyxHQUlOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQVkvQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFHN0UsT0FBTyxPQUFPLE1BQU0sZUFBZSxDQUFDOzs7QUFvQ3BDLE1BQU0sQ0FBQyxPQUFPLE9BQU8sa0JBQWtCO0lBWXJDLElBQUksVUFBVTtRQUNaLE9BQU8sSUFBSSxDQUFDLGlCQUFpQjtZQUMzQixDQUFDLENBQUM7Z0JBQ0UsR0FBRyxrQkFBa0IsQ0FBQztvQkFDcEIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO29CQUNqQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87aUJBQ3RCLENBQUM7Z0JBQ0YsR0FBRyxlQUFlLENBQUM7b0JBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztvQkFDakIsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUztvQkFDakMsWUFBWSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWTtvQkFDdkMsVUFBVSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVTtvQkFDbkMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTztpQkFDOUIsQ0FBQzthQUNIO1lBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNULENBQUM7SUFHRCxZQUFvQixLQUF1QixFQUFVLFFBQW1C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RSxPQUFPOzs0RkFFWixrQkFBa0I7a0JBbEN0QyxTQUFTOytCQUNFLHFCQUFxQixZQUNyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJULGNBUVcsSUFBSSxXQUNQLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQzsrSEFHdkIsaUJBQWlCO3NCQUF6QixLQUFLO2dCQUNHLEtBQUs7c0JBQWIsS0FBSztnQkFDRyxPQUFPO3NCQUFmLEtBQUs7Z0JBQ0csT0FBTztzQkFBZixLQUFLO2dCQUNHLFlBQVk7c0JBQXBCLEtBQUs7Z0JBR04sa0JBQWtCO3NCQURqQixTQUFTO3VCQUFDLGlCQUFpQixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgICAgICAgUmVuZGVyZXIyLFxuICAgICAgICAgIHJlZmxlY3RDb21wb25lbnRUeXBlLFxuICAgICAgICAgIFxuICBDb21wb25lbnQsXG4gIFZpZXdDaGlsZCxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIFRlbXBsYXRlUmVmLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQ29tbW9uTW9kdWxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vblwiO1xuXG5leHBvcnQgdHlwZSBJbnRlcmFjdGl2ZUVsZW1lbnRQcm9wcyA9IHtcbiAgV3JhcHBlcjogYW55O1xuICBibG9jazogQnVpbGRlckJsb2NrO1xuICBjb250ZXh0OiBCdWlsZGVyQ29udGV4dEludGVyZmFjZTtcbiAgd3JhcHBlclByb3BzOiBEaWN0aW9uYXJ5PGFueT47XG4gIGluY2x1ZGVCbG9ja1Byb3BzOiBib29sZWFuO1xuICBjaGlsZHJlbj86IGFueTtcbn07XG5cbmltcG9ydCB0eXBlIHsgQnVpbGRlckNvbnRleHRJbnRlcmZhY2UgfSBmcm9tIFwiLi4vLi4vLi4vY29udGV4dC90eXBlc1wiO1xuaW1wb3J0IHsgZ2V0QmxvY2tBY3Rpb25zIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9nZXQtYmxvY2stYWN0aW9uc1wiO1xuaW1wb3J0IHsgZ2V0QmxvY2tQcm9wZXJ0aWVzIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9nZXQtYmxvY2stcHJvcGVydGllc1wiO1xuaW1wb3J0IHR5cGUgeyBCdWlsZGVyQmxvY2sgfSBmcm9tIFwiLi4vLi4vLi4vdHlwZXMvYnVpbGRlci1ibG9ja1wiO1xuaW1wb3J0IHR5cGUgeyBEaWN0aW9uYXJ5IH0gZnJvbSBcIi4uLy4uLy4uL3R5cGVzL3R5cGVzY3JpcHRcIjtcbmltcG9ydCBBd2FpdGVyIGZyb20gXCIuLi8uLi9hd2FpdGVyXCI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogXCJpbnRlcmFjdGl2ZS1lbGVtZW50XCIsXG4gIHRlbXBsYXRlOiBgXG4gICAgPG5nLXRlbXBsYXRlICN3cmFwcGVyVGVtcGxhdGU+PG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PjwvbmctdGVtcGxhdGU+XG4gICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cIldyYXBwZXIubG9hZFwiPlxuICAgICAgPGF3YWl0ZXJcbiAgICAgICAgW2xvYWRdPVwiV3JhcHBlci5sb2FkXCJcbiAgICAgICAgW2ZhbGxiYWNrXT1cIldyYXBwZXIuZmFsbGJhY2tcIlxuICAgICAgICBbcHJvcHNdPVwid3JhcHBlclByb3BzXCJcbiAgICAgICAgW2F0dHJpYnV0ZXNdPVwiYXR0cmlidXRlc1wiXG4gICAgICA+XG4gICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICAgIDwvYXdhaXRlcj5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiIShXcmFwcGVyLmxvYWQpXCI+XG4gICAgICA8bmctY29udGFpbmVyXG4gICAgICAgICpuZ0NvbXBvbmVudE91dGxldD1cIlxuICAgICAgICAgICAgICBXcmFwcGVyO1xuICAgICAgICAgICAgICBpbnB1dHM6IG1lcmdlZElucHV0c19hdGtqaDI7XG4gICAgICAgICAgICAgIGNvbnRlbnQ6IG15Q29udGVudDtcbiAgICAgICAgICAgICAgXCJcbiAgICAgID48L25nLWNvbnRhaW5lcj5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgYCxcbiAgc3R5bGVzOiBbXG4gICAgYFxuICAgICAgOmhvc3Qge1xuICAgICAgICBkaXNwbGF5OiBjb250ZW50cztcbiAgICAgIH1cbiAgICBgLFxuICBdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxuICBpbXBvcnRzOiBbQ29tbW9uTW9kdWxlLCBBd2FpdGVyXSxcbn0pXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnRlcmFjdGl2ZUVsZW1lbnQge1xuICBASW5wdXQoKSBpbmNsdWRlQmxvY2tQcm9wcyE6IEludGVyYWN0aXZlRWxlbWVudFByb3BzW1wiaW5jbHVkZUJsb2NrUHJvcHNcIl07XG4gIEBJbnB1dCgpIGJsb2NrITogSW50ZXJhY3RpdmVFbGVtZW50UHJvcHNbXCJibG9ja1wiXTtcbiAgQElucHV0KCkgY29udGV4dCE6IEludGVyYWN0aXZlRWxlbWVudFByb3BzW1wiY29udGV4dFwiXTtcbiAgQElucHV0KCkgV3JhcHBlciE6IEludGVyYWN0aXZlRWxlbWVudFByb3BzW1wiV3JhcHBlclwiXTtcbiAgQElucHV0KCkgd3JhcHBlclByb3BzITogSW50ZXJhY3RpdmVFbGVtZW50UHJvcHNbXCJ3cmFwcGVyUHJvcHNcIl07XG5cbiAgQFZpZXdDaGlsZChcIndyYXBwZXJUZW1wbGF0ZVwiLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICB3cmFwcGVyVGVtcGxhdGVSZWYhOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIG15Q29udGVudD86IGFueVtdW107XG5cbiAgZ2V0IGF0dHJpYnV0ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW5jbHVkZUJsb2NrUHJvcHNcbiAgICAgID8ge1xuICAgICAgICAgIC4uLmdldEJsb2NrUHJvcGVydGllcyh7XG4gICAgICAgICAgICBibG9jazogdGhpcy5ibG9jayxcbiAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMuY29udGV4dCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICAuLi5nZXRCbG9ja0FjdGlvbnMoe1xuICAgICAgICAgICAgYmxvY2s6IHRoaXMuYmxvY2ssXG4gICAgICAgICAgICByb290U3RhdGU6IHRoaXMuY29udGV4dC5yb290U3RhdGUsXG4gICAgICAgICAgICByb290U2V0U3RhdGU6IHRoaXMuY29udGV4dC5yb290U2V0U3RhdGUsXG4gICAgICAgICAgICBsb2NhbFN0YXRlOiB0aGlzLmNvbnRleHQubG9jYWxTdGF0ZSxcbiAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMuY29udGV4dC5jb250ZXh0LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9XG4gICAgICA6IHt9O1xuICB9XG4gIG1lcmdlZElucHV0c19hdGtqaDIgPSB7fSBhcyBhbnk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2Y1JlZjogVmlld0NvbnRhaW5lclJlZiwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMubWVyZ2VkSW5wdXRzX2F0a2poMiA9IHtcbiAgICAgIC4uLnRoaXMuZmlsdGVyUHJvcHNUaGF0V3JhcHBlck5lZWRzKHRoaXMud3JhcHBlclByb3BzKSxcbiAgICAgIC4uLih0aGlzLmhhc0F0dHJpYnV0ZXNJbnB1dCh0aGlzLldyYXBwZXIpID8geyBhdHRyaWJ1dGVzOiB0aGlzLmF0dHJpYnV0ZXMgfSA6IHt9KVxuICAgIH07XG5cbiAgICB0aGlzLm15Q29udGVudCA9IFtcbiAgICAgIHRoaXMudmNSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMud3JhcHBlclRlbXBsYXRlUmVmKS5yb290Tm9kZXMsXG4gICAgXTtcbiAgfVxuXG4gICAgXG4gIF9saXN0ZW5lckZucyA9IG5ldyBNYXA8c3RyaW5nLCAoKSA9PiB2b2lkPigpO1xuXG4gIHByaXZhdGUgaGFzQXR0cmlidXRlc0lucHV0KGNvbXBvbmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXJlZmxlY3RDb21wb25lbnRUeXBlKGNvbXBvbmVudCk/LmlucHV0cy5maW5kKGlucHV0ID0+IGlucHV0LnByb3BOYW1lID09PSAnYXR0cmlidXRlcycpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVBdHRyaWJ1dGVzKFxuICAgIGVsOiBIVE1MRWxlbWVudCxcbiAgICBhdHRyaWJ1dGVzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpLmZvckVhY2goKGF0dHIpID0+IHtcbiAgICAgIGlmIChhdHRyLnN0YXJ0c1dpdGgoXCJvblwiKSkge1xuICAgICAgICBpZiAodGhpcy5fbGlzdGVuZXJGbnMuaGFzKGF0dHIpKSB7XG4gICAgICAgICAgdGhpcy5fbGlzdGVuZXJGbnMuZ2V0KGF0dHIpISgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2xpc3RlbmVyRm5zLnNldChcbiAgICAgICAgICBhdHRyLFxuICAgICAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKFxuICAgICAgICAgICAgZWwsXG4gICAgICAgICAgICBhdHRyLnJlcGxhY2UoXCJvblwiLCBcIlwiKS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgYXR0cmlidXRlc1thdHRyXVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoYXR0ciA9PT0gJ2NsYXNzJyAmJiBhdHRyaWJ1dGVzW2F0dHJdKSB7XG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSBhdHRyaWJ1dGVzW2F0dHJdLnNwbGl0KCcgJyk7XG4gICAgICAgIGNsYXNzZXMuZm9yRWFjaCgoY2xzOiBzdHJpbmcpID0+XG4gICAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbCwgY2xzLnRyaW0oKSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGVsLCBhdHRyLnRvTG93ZXJDYXNlKCksIGF0dHJpYnV0ZXNbYXR0cl0gPz8gXCJcIik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKCF0aGlzLmhhc0F0dHJpYnV0ZXNJbnB1dCh0aGlzLldyYXBwZXIpKSB7XG4gICAgICBjb25zdCB3cmFwcGVyRWxlbWVudCA9XG4gICAgICAgIHRoaXMud3JhcHBlclRlbXBsYXRlUmVmLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudD8ubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgICAgaWYgKHdyYXBwZXJFbGVtZW50KSB7XG4gICAgICAgIHRoaXMudXBkYXRlQXR0cmlidXRlcyh3cmFwcGVyRWxlbWVudCwgdGhpcy5hdHRyaWJ1dGVzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBmb3IgKGNvbnN0IGZuIG9mIHRoaXMuX2xpc3RlbmVyRm5zLnZhbHVlcygpKSB7XG4gICAgICBmbigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyUHJvcHNUaGF0V3JhcHBlck5lZWRzKGFsbFByb3BzOiBhbnkpIHtcbiAgICBjb25zdCBkZWZpbmVkUHJvcE5hbWVzID0gcmVmbGVjdENvbXBvbmVudFR5cGUodGhpcy5XcmFwcGVyKS5pbnB1dHMubWFwKHByb3AgPT4gcHJvcC5wcm9wTmFtZSk7XG4gICAgcmV0dXJuIGRlZmluZWRQcm9wTmFtZXMucmVkdWNlKChhY2MsIHByb3BOYW1lKSA9PiB7XG4gICAgICBhY2NbcHJvcE5hbWVdID0gYWxsUHJvcHNbcHJvcE5hbWVdO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG4gIH1cbm5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHsgaWYgKGNoYW5nZXNbXCJhdHRyaWJ1dGVzXCJdICYmICF0aGlzLmhhc0F0dHJpYnV0ZXNJbnB1dCh0aGlzLldyYXBwZXIpKSB7IHRoaXMubmdBZnRlclZpZXdJbml0KCk7IH1cbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdGhpcy5tZXJnZWRJbnB1dHNfYXRramgyID0ge1xuICAgICAgICAuLi50aGlzLmZpbHRlclByb3BzVGhhdFdyYXBwZXJOZWVkcyh0aGlzLndyYXBwZXJQcm9wcyksXG4gICAgICAgIC4uLih0aGlzLmhhc0F0dHJpYnV0ZXNJbnB1dCh0aGlzLldyYXBwZXIpID8geyBhdHRyaWJ1dGVzOiB0aGlzLmF0dHJpYnV0ZXMgfSA6IHt9KVxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==