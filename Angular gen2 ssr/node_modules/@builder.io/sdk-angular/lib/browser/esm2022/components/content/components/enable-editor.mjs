import { Component, ViewChild, Input, } from "@angular/core";
import { CommonModule } from "@angular/common";
import builderContext from "../../../context/builder.context";
import { evaluate } from "../../../functions/evaluate/index";
import { fastClone } from "../../../functions/fast-clone";
import { fetchOneEntry } from "../../../functions/get-content/index";
import { isBrowser } from "../../../functions/is-browser";
import { isEditing } from "../../../functions/is-editing";
import { isPreviewing } from "../../../functions/is-previewing";
import { logFetch } from "../../../functions/log-fetch";
import { createRegisterComponentMessage } from "../../../functions/register-component";
import { _track } from "../../../functions/track/index";
import { getInteractionPropertiesForEvent } from "../../../functions/track/interaction";
import { getDefaultCanTrack } from "../../../helpers/canTrack";
import { createEditorListener } from "../../../helpers/subscribe-to-editor";
import { registerInsertMenu, setupBrowserForEditing, } from "../../../scripts/init-editing";
import { triggerAnimation } from "../../block/animator";
import DynamicDiv from "../../dynamic-div";
import { needsElementRefDivForEditing } from "./enable-editor.helpers";
import { getWrapperClassName } from "./styles.helpers";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export default class EnableEditor {
    mergeNewRootState(newData) {
        const combinedState = {
            ...this.builderContextSignal.rootState,
            ...newData,
        };
        if (this.builderContextSignal.rootSetState) {
            this.builderContextSignal.rootSetState?.(combinedState);
        }
        else {
            this.builderContextSignal.rootState = combinedState;
        }
    }
    mergeNewContent(newContent) {
        const newContentValue = {
            ...this.builderContextSignal.content,
            ...newContent,
            data: {
                ...this.builderContextSignal.content?.data,
                ...newContent?.data,
            },
            meta: {
                ...this.builderContextSignal.content?.meta,
                ...newContent?.meta,
                breakpoints: newContent?.meta?.breakpoints ||
                    this.builderContextSignal.content?.meta?.breakpoints,
            },
        };
        this.builderContextSignal.content = newContentValue;
    }
    get showContentProps() {
        return this.showContent
            ? {}
            : {
                hidden: true,
                "aria-hidden": true,
            };
    }
    processMessage(event) {
        return createEditorListener({
            model: this.model,
            trustedHosts: this.trustedHosts,
            callbacks: {
                configureSdk: (messageContent) => {
                    const { breakpoints, contentId } = messageContent;
                    if (!contentId ||
                        contentId !== this.builderContextSignal.content?.id) {
                        return;
                    }
                    if (breakpoints) {
                        this.mergeNewContent({
                            meta: {
                                breakpoints,
                            },
                        });
                    }
                },
                animation: (animation) => {
                    triggerAnimation(animation);
                },
                contentUpdate: (newContent) => {
                    this.mergeNewContent(newContent);
                },
            },
        })(event);
    }
    onClick(event) {
        if (this.builderContextSignal.content) {
            const variationId = this.builderContextSignal.content?.testVariationId;
            const contentId = this.builderContextSignal.content?.id;
            _track({
                apiHost: this.apiHost,
                type: "click",
                canTrack: getDefaultCanTrack(this.canTrack),
                contentId,
                apiKey: this.apiKey,
                variationId: variationId !== contentId ? variationId : undefined,
                ...getInteractionPropertiesForEvent(event),
                unique: !this.clicked,
            });
        }
        if (!this.clicked) {
            this.clicked = true;
        }
    }
    runHttpRequests() {
        const requests = this.builderContextSignal.content?.data?.httpRequests ?? {};
        Object.entries(requests).forEach(([key, url]) => {
            if (!url)
                return;
            // request already in progress
            if (this.httpReqsPending[key])
                return;
            // request already completed, and not in edit mode
            if (this.httpReqsData[key] && !isEditing())
                return;
            this.httpReqsPending[key] = true;
            const evaluatedUrl = url.replace(/{{([^}]+)}}/g, (_match, group) => String(evaluate({
                code: group,
                context: this.context || {},
                localState: undefined,
                rootState: this.builderContextSignal.rootState,
                rootSetState: this.builderContextSignal.rootSetState,
            })));
            logFetch(evaluatedUrl);
            fetch(evaluatedUrl)
                .then((response) => response.json())
                .then((json) => {
                this.mergeNewRootState({
                    [key]: json,
                });
                this.httpReqsData[key] = true;
            })
                .catch((err) => {
                console.error("error fetching dynamic data", url, err);
            })
                .finally(() => {
                this.httpReqsPending[key] = false;
            });
        });
    }
    emitStateUpdate() {
        if (isEditing()) {
            window.dispatchEvent(new CustomEvent("builder:component:stateChange", {
                detail: {
                    state: fastClone(this.builderContextSignal.rootState),
                    ref: {
                        name: this.model,
                    },
                },
            }));
        }
    }
    constructor(vcRef) {
        this.vcRef = vcRef;
        this.builderContext = builderContext;
        this.ContentWrapper = null;
        this.httpReqsData = {};
        this.httpReqsPending = {};
        this.clicked = false;
        this.node_0_Show = null;
        this.node_2_state_ContentWrapper = null;
        this.node_3_state_ContentWrapper = null;
        this.mergedInputs_ekawrq = {};
    }
    ngOnInit() {
        this.ContentWrapper = this.contentWrapper || DynamicDiv;
        this.runHttpRequests();
        this.emitStateUpdate();
        this.node_0_Show =
            this.builderContextSignal.content || needsElementRefDivForEditing();
        this.node_2_state_ContentWrapper = getWrapperClassName(this.content?.testVariationId || this.content?.id);
        this.node_3_state_ContentWrapper = {
            display: !this.builderContextSignal.content && needsElementRefDivForEditing()
                ? "none"
                : undefined,
        };
        this.mergedInputs_ekawrq = {
            ref: this.elementRef,
            onClick: this.onClick.bind(this),
            "builder-content-id": this.builderContextSignal.content?.id,
            "builder-model": this.model,
            className: this.node_2_state_ContentWrapper,
            style: this.node_3_state_ContentWrapper,
            ...this.showContentProps,
            ...this.contentWrapperProps,
        };
        if (typeof window !== "undefined") {
            if (isBrowser()) {
                if (isEditing() && !this.isNestedRender) {
                    window.addEventListener("message", this.processMessage.bind(this));
                    registerInsertMenu();
                    setupBrowserForEditing({
                        ...(this.locale
                            ? {
                                locale: this.locale,
                            }
                            : {}),
                        ...(this.enrich
                            ? {
                                enrich: this.enrich,
                            }
                            : {}),
                        ...(this.trustedHosts
                            ? {
                                trustedHosts: this.trustedHosts,
                            }
                            : {}),
                        modelName: this.model ?? "",
                        apiKey: this.apiKey,
                    });
                    Object.values(this.builderContextSignal.componentInfos).forEach((registeredComponent) => {
                        if (!registeredComponent.models?.length ||
                            registeredComponent.models.includes(this.model)) {
                            const message = createRegisterComponentMessage(registeredComponent);
                            window.parent?.postMessage(message, "*");
                        }
                    });
                    window.addEventListener("builder:component:stateChangeListenerActivated", this.emitStateUpdate
                        .bind(this));
                }
                const shouldTrackImpression = this.builderContextSignal.content &&
                    getDefaultCanTrack(this.canTrack);
                if (shouldTrackImpression) {
                    const variationId = this.builderContextSignal.content?.testVariationId;
                    const contentId = this.builderContextSignal.content?.id;
                    const apiKeyProp = this.apiKey;
                    _track({
                        apiHost: this.apiHost,
                        type: "impression",
                        canTrack: true,
                        contentId,
                        apiKey: apiKeyProp,
                        variationId: variationId !== contentId ? variationId : undefined,
                    });
                }
                /**
                 * Override normal content in preview mode.
                 * We ignore this when editing, since the edited content is already being sent from the editor via post messages.
                 */
                if (isPreviewing() && !isEditing()) {
                    const searchParams = new URL(location.href).searchParams;
                    const searchParamPreviewModel = searchParams.get("builder.preview");
                    const searchParamPreviewId = searchParams.get(`builder.overrides.${searchParamPreviewModel}`);
                    const previewApiKey = searchParams.get("apiKey") || searchParams.get("builder.space");
                    /**
                     * Make sure that:
                     * - the preview model name is the same as the one we're rendering, since there can be multiple models rendered
                     *  at the same time, e.g. header/page/footer.
                     * - the API key is the same, since we don't want to preview content from other organizations.
                     * - if there is content, that the preview ID is the same as that of the one we receive.
                     *
                     * TO-DO: should we only update the state when there is a change?
                     **/
                    if (searchParamPreviewModel === "BUILDER_STUDIO" ||
                        (searchParamPreviewModel === this.model &&
                            previewApiKey === this.apiKey &&
                            (!this.content || searchParamPreviewId === this.content.id))) {
                        fetchOneEntry({
                            model: this.model,
                            apiKey: this.apiKey,
                            apiVersion: this.builderContextSignal.apiVersion,
                            ...(searchParamPreviewModel === "BUILDER_STUDIO" &&
                                this.context?.symbolId
                                ? {
                                    query: {
                                        id: this.context.symbolId,
                                    },
                                }
                                : {}),
                        }).then((content) => {
                            if (content) {
                                this.mergeNewContent(content);
                            }
                        });
                    }
                }
            }
        }
        this.myContent = [
            this.vcRef.createEmbeddedView(this.contentwrapperTemplateRef).rootNodes,
        ];
    }
    ngOnChanges(changes) {
        if (typeof window !== "undefined") {
            if (this.content) {
                this.mergeNewContent(this.content);
            }
            this.emitStateUpdate();
            if (this.data) {
                this.mergeNewRootState(this.data);
            }
            if (this.locale) {
                this.mergeNewRootState({
                    locale: this.locale,
                });
            }
            this.node_0_Show =
                this.builderContextSignal.content || needsElementRefDivForEditing();
            this.node_2_state_ContentWrapper = getWrapperClassName(this.content?.testVariationId || this.content?.id);
            this.node_3_state_ContentWrapper = {
                display: !this.builderContextSignal.content && needsElementRefDivForEditing()
                    ? "none"
                    : undefined,
            };
            this.mergedInputs_ekawrq = {
                ref: this.elementRef,
                onClick: this.onClick.bind(this),
                "builder-content-id": this.builderContextSignal.content?.id,
                "builder-model": this.model,
                className: this.node_2_state_ContentWrapper,
                style: this.node_3_state_ContentWrapper,
                ...this.showContentProps,
                ...this.contentWrapperProps,
            };
        }
    }
    ngOnDestroy() {
        if (isBrowser()) {
            window.removeEventListener("message", this.processMessage.bind(this));
            window.removeEventListener("builder:component:stateChangeListenerActivated", this.emitStateUpdate
                .bind(this));
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: EnableEditor, deps: [{ token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: EnableEditor, isStandalone: true, selector: "enable-editor", inputs: { isNestedRender: "isNestedRender", locale: "locale", enrich: "enrich", trustedHosts: "trustedHosts", model: "model", apiKey: "apiKey", builderContextSignal: "builderContextSignal", canTrack: "canTrack", apiHost: "apiHost", content: "content", context: "context", data: "data", showContent: "showContent", contentWrapper: "contentWrapper", contentWrapperProps: "contentWrapperProps" }, viewQueries: [{ propertyName: "elementRef", first: true, predicate: ["elementRef"], descendants: true }, { propertyName: "contentwrapperTemplateRef", first: true, predicate: ["contentwrapperTemplate"], descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: `
    <ng-template #contentwrapperTemplate><ng-content></ng-content></ng-template>
    <ng-container *ngIf="node_0_Show">
      <ng-container
        *ngComponentOutlet="
              ContentWrapper;
              inputs: mergedInputs_ekawrq;
              content: myContent;
              "
      ></ng-container>
    </ng-container>
  `, isInline: true, styles: [":host{display:contents}\n"], dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgComponentOutlet, selector: "[ngComponentOutlet]", inputs: ["ngComponentOutlet", "ngComponentOutletInputs", "ngComponentOutletInjector", "ngComponentOutletContent", "ngComponentOutletNgModule", "ngComponentOutletNgModuleFactory"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: EnableEditor, decorators: [{
            type: Component,
            args: [{ selector: "enable-editor", template: `
    <ng-template #contentwrapperTemplate><ng-content></ng-content></ng-template>
    <ng-container *ngIf="node_0_Show">
      <ng-container
        *ngComponentOutlet="
              ContentWrapper;
              inputs: mergedInputs_ekawrq;
              content: myContent;
              "
      ></ng-container>
    </ng-container>
  `, standalone: true, imports: [CommonModule], styles: [":host{display:contents}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }]; }, propDecorators: { isNestedRender: [{
                type: Input
            }], locale: [{
                type: Input
            }], enrich: [{
                type: Input
            }], trustedHosts: [{
                type: Input
            }], model: [{
                type: Input
            }], apiKey: [{
                type: Input
            }], builderContextSignal: [{
                type: Input
            }], canTrack: [{
                type: Input
            }], apiHost: [{
                type: Input
            }], content: [{
                type: Input
            }], context: [{
                type: Input
            }], data: [{
                type: Input
            }], showContent: [{
                type: Input
            }], contentWrapper: [{
                type: Input
            }], contentWrapperProps: [{
                type: Input
            }], elementRef: [{
                type: ViewChild,
                args: ["elementRef"]
            }], contentwrapperTemplateRef: [{
                type: ViewChild,
                args: ["contentwrapperTemplate", { static: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5hYmxlLWVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2NvbnRlbnQvY29tcG9uZW50cy9lbmFibGUtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsU0FBUyxFQUVULEtBQUssR0FJTixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFnQi9DLE9BQU8sY0FBYyxNQUFNLGtDQUFrQyxDQUFDO0FBRTlELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUN2RixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEQsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDeEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFL0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDNUUsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixzQkFBc0IsR0FDdkIsTUFBTSwrQkFBK0IsQ0FBQztBQUl2QyxPQUFPLEVBQUUsZ0JB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WixZQUFZLHN0QkF0QnJCOzs7Ozs7Ozs7OztHQVdULGtHQVNTLFlBQVk7OzRGQUVILFlBQVk7a0JBeEJoQyxTQUFTOytCQUNFLGVBQWUsWUFDZjs7Ozs7Ozs7Ozs7R0FXVCxjQVFXLElBQUksV0FDUCxDQUFDLFlBQVksQ0FBQzt1R0FLZCxjQUFjO3NCQUF0QixLQUFLO2dCQUNHLE1BQU07c0JBQWQsS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csWUFBWTtzQkFBcEIsS0FBSztnQkFDRyxLQUFLO3NCQUFiLEtBQUs7Z0JBQ0csTUFBTTtzQkFBZCxLQUFLO2dCQUNHLG9CQUFvQjtzQkFBNUIsS0FBSztnQkFDRyxRQUFRO3NCQUFoQixLQUFLO2dCQUNHLE9BQU87c0JBQWYsS0FBSztnQkFDRyxPQUFPO3NCQUFmLEtBQUs7Z0JBQ0csT0FBTztzQkFBZixLQUFLO2dCQUNHLElBQUk7c0JBQVosS0FBSztnQkFDRyxXQUFXO3NCQUFuQixLQUFLO2dCQUNHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBQ0csbUJBQW1CO3NCQUEzQixLQUFLO2dCQUVtQixVQUFVO3NCQUFsQyxTQUFTO3VCQUFDLFlBQVk7Z0JBR3ZCLHlCQUF5QjtzQkFEeEIsU0FBUzt1QkFBQyx3QkFBd0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIFZpZXdDaGlsZCxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIFRlbXBsYXRlUmVmLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQ29tbW9uTW9kdWxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vblwiO1xuXG50eXBlIEJ1aWxkZXJFZGl0b3JQcm9wcyA9IE9taXQ8XG4gIENvbnRlbnRQcm9wcyxcbiAgfCBcImN1c3RvbUNvbXBvbmVudHNcIlxuICB8IFwiYXBpVmVyc2lvblwiXG4gIHwgXCJpc1NzckFiVGVzdFwiXG4gIHwgXCJibG9ja3NXcmFwcGVyXCJcbiAgfCBcImJsb2Nrc1dyYXBwZXJQcm9wc1wiXG4gIHwgXCJsaW5rQ29tcG9uZW50XCJcbj4gJiB7XG4gIGJ1aWxkZXJDb250ZXh0U2lnbmFsOiBCdWlsZGVyQ29udGV4dEludGVyZmFjZTtcbiAgc2V0QnVpbGRlckNvbnRleHRTaWduYWw/OiAoc2lnbmFsOiBhbnkpID0+IGFueTtcbiAgY2hpbGRyZW4/OiBhbnk7XG59O1xuXG5pbXBvcnQgYnVpbGRlckNvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHQvYnVpbGRlci5jb250ZXh0XCI7XG5pbXBvcnQgdHlwZSB7IEJ1aWxkZXJDb250ZXh0SW50ZXJmYWNlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbnRleHQvdHlwZXNcIjtcbmltcG9ydCB7IGV2YWx1YXRlIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9ldmFsdWF0ZS9pbmRleFwiO1xuaW1wb3J0IHsgZmFzdENsb25lIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9mYXN0LWNsb25lXCI7XG5pbXBvcnQgeyBmZXRjaE9uZUVudHJ5IH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9nZXQtY29udGVudC9pbmRleFwiO1xuaW1wb3J0IHsgaXNCcm93c2VyIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9pcy1icm93c2VyXCI7XG5pbXBvcnQgeyBpc0VkaXRpbmcgfSBmcm9tIFwiLi4vLi4vLi4vZnVuY3Rpb25zL2lzLWVkaXRpbmdcIjtcbmltcG9ydCB7IGlzUHJldmlld2luZyB9IGZyb20gXCIuLi8uLi8uLi9mdW5jdGlvbnMvaXMtcHJldmlld2luZ1wiO1xuaW1wb3J0IHsgbG9nRmV0Y2ggfSBmcm9tIFwiLi4vLi4vLi4vZnVuY3Rpb25zL2xvZy1mZXRjaFwiO1xuaW1wb3J0IHsgY3JlYXRlUmVnaXN0ZXJDb21wb25lbnRNZXNzYWdlIH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy9yZWdpc3Rlci1jb21wb25lbnRcIjtcbmltcG9ydCB7IF90cmFjayB9IGZyb20gXCIuLi8uLi8uLi9mdW5jdGlvbnMvdHJhY2svaW5kZXhcIjtcbmltcG9ydCB7IGdldEludGVyYWN0aW9uUHJvcGVydGllc0ZvckV2ZW50IH0gZnJvbSBcIi4uLy4uLy4uL2Z1bmN0aW9ucy90cmFjay9pbnRlcmFjdGlvblwiO1xuaW1wb3J0IHsgZ2V0RGVmYXVsdENhblRyYWNrIH0gZnJvbSBcIi4uLy4uLy4uL2hlbHBlcnMvY2FuVHJhY2tcIjtcbmltcG9ydCB7IHBvc3RQcmV2aWV3Q29udGVudCB9IGZyb20gXCIuLi8uLi8uLi9oZWxwZXJzL3ByZXZpZXctbHJ1LWNhY2hlL3NldFwiO1xuaW1wb3J0IHsgY3JlYXRlRWRpdG9yTGlzdGVuZXIgfSBmcm9tIFwiLi4vLi4vLi4vaGVscGVycy9zdWJzY3JpYmUtdG8tZWRpdG9yXCI7XG5pbXBvcnQge1xuICByZWdpc3Rlckluc2VydE1lbnUsXG4gIHNldHVwQnJvd3NlckZvckVkaXRpbmcsXG59IGZyb20gXCIuLi8uLi8uLi9zY3JpcHRzL2luaXQtZWRpdGluZ1wiO1xuaW1wb3J0IHR5cGUgeyBCdWlsZGVyQ29udGVudCB9IGZyb20gXCIuLi8uLi8uLi90eXBlcy9idWlsZGVyLWNvbnRlbnRcIjtcbmltcG9ydCB0eXBlIHsgQ29tcG9uZW50SW5mbyB9IGZyb20gXCIuLi8uLi8uLi90eXBlcy9jb21wb25lbnRzXCI7XG5pbXBvcnQgdHlwZSB7IERpY3Rpb25hcnkgfSBmcm9tIFwiLi4vLi4vLi4vdHlwZXMvdHlwZXNjcmlwdFwiO1xuaW1wb3J0IHsgdHJpZ2dlckFuaW1hdGlvbiB9IGZyb20gXCIuLi8uLi9ibG9jay9hbmltYXRvclwiO1xuaW1wb3J0IER5bmFtaWNEaXYgZnJvbSBcIi4uLy4uL2R5bmFtaWMtZGl2XCI7XG5pbXBvcnQgdHlwZSB7XG4gIEJ1aWxkZXJDb21wb25lbnRTdGF0ZUNoYW5nZSxcbiAgQ29udGVudFByb3BzLFxufSBmcm9tIFwiLi4vY29udGVudC50eXBlc1wiO1xuaW1wb3J0IHsgbmVlZHNFbGVtZW50UmVmRGl2Rm9yRWRpdGluZyB9IGZyb20gXCIuL2VuYWJsZS1lZGl0b3IuaGVscGVyc1wiO1xuaW1wb3J0IHsgZ2V0V3JhcHBlckNsYXNzTmFtZSB9IGZyb20gXCIuL3N0eWxlcy5oZWxwZXJzXCI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogXCJlbmFibGUtZWRpdG9yXCIsXG4gIHRlbXBsYXRlOiBgXG4gICAgPG5nLXRlbXBsYXRlICNjb250ZW50d3JhcHBlclRlbXBsYXRlPjxuZy1jb250ZW50PjwvbmctY29udGVudD48L25nLXRlbXBsYXRlPlxuICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJub2RlXzBfU2hvd1wiPlxuICAgICAgPG5nLWNvbnRhaW5lclxuICAgICAgICAqbmdDb21wb25lbnRPdXRsZXQ9XCJcbiAgICAgICAgICAgICAgQ29udGVudFdyYXBwZXI7XG4gICAgICAgICAgICAgIGlucHV0czogbWVyZ2VkSW5wdXRzX2VrYXdycTtcbiAgICAgICAgICAgICAgY29udGVudDogbXlDb250ZW50O1xuICAgICAgICAgICAgICBcIlxuICAgICAgPjwvbmctY29udGFpbmVyPlxuICAgIDwvbmctY29udGFpbmVyPlxuICBgLFxuICBzdHlsZXM6IFtcbiAgICBgXG4gICAgICA6aG9zdCB7XG4gICAgICAgIGRpc3BsYXk6IGNvbnRlbnRzO1xuICAgICAgfVxuICAgIGAsXG4gIF0sXG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIGltcG9ydHM6IFtDb21tb25Nb2R1bGVdLFxufSlcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVuYWJsZUVkaXRvciB7XG4gIGJ1aWxkZXJDb250ZXh0ID0gYnVpbGRlckNvbnRleHQ7XG5cbiAgQElucHV0KCkgaXNOZXN0ZWRSZW5kZXIhOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJpc05lc3RlZFJlbmRlclwiXTtcbiAgQElucHV0KCkgbG9jYWxlITogQnVpbGRlckVkaXRvclByb3BzW1wibG9jYWxlXCJdO1xuICBASW5wdXQoKSBlbnJpY2ghOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJlbnJpY2hcIl07XG4gIEBJbnB1dCgpIHRydXN0ZWRIb3N0cyE6IEJ1aWxkZXJFZGl0b3JQcm9wc1tcInRydXN0ZWRIb3N0c1wiXTtcbiAgQElucHV0KCkgbW9kZWwhOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJtb2RlbFwiXTtcbiAgQElucHV0KCkgYXBpS2V5ITogQnVpbGRlckVkaXRvclByb3BzW1wiYXBpS2V5XCJdO1xuICBASW5wdXQoKSBidWlsZGVyQ29udGV4dFNpZ25hbCE6IEJ1aWxkZXJFZGl0b3JQcm9wc1tcImJ1aWxkZXJDb250ZXh0U2lnbmFsXCJdO1xuICBASW5wdXQoKSBjYW5UcmFjayE6IEJ1aWxkZXJFZGl0b3JQcm9wc1tcImNhblRyYWNrXCJdO1xuICBASW5wdXQoKSBhcGlIb3N0ITogQnVpbGRlckVkaXRvclByb3BzW1wiYXBpSG9zdFwiXTtcbiAgQElucHV0KCkgY29udGVudCE6IEJ1aWxkZXJFZGl0b3JQcm9wc1tcImNvbnRlbnRcIl07XG4gIEBJbnB1dCgpIGNvbnRleHQhOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJjb250ZXh0XCJdO1xuICBASW5wdXQoKSBkYXRhITogQnVpbGRlckVkaXRvclByb3BzW1wiZGF0YVwiXTtcbiAgQElucHV0KCkgc2hvd0NvbnRlbnQhOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJzaG93Q29udGVudFwiXTtcbiAgQElucHV0KCkgY29udGVudFdyYXBwZXIhOiBCdWlsZGVyRWRpdG9yUHJvcHNbXCJjb250ZW50V3JhcHBlclwiXTtcbiAgQElucHV0KCkgY29udGVudFdyYXBwZXJQcm9wcyE6IEJ1aWxkZXJFZGl0b3JQcm9wc1tcImNvbnRlbnRXcmFwcGVyUHJvcHNcIl07XG5cbiAgQFZpZXdDaGlsZChcImVsZW1lbnRSZWZcIikgZWxlbWVudFJlZiE6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZChcImNvbnRlbnR3cmFwcGVyVGVtcGxhdGVcIiwgeyBzdGF0aWM6IHRydWUgfSlcbiAgY29udGVudHdyYXBwZXJUZW1wbGF0ZVJlZiE6IFRlbXBsYXRlUmVmPGFueT47XG5cbiAgbXlDb250ZW50PzogYW55W11bXTtcblxuICBtZXJnZU5ld1Jvb3RTdGF0ZShuZXdEYXRhOiBEaWN0aW9uYXJ5PGFueT4pIHtcbiAgICBjb25zdCBjb21iaW5lZFN0YXRlID0ge1xuICAgICAgLi4udGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5yb290U3RhdGUsXG4gICAgICAuLi5uZXdEYXRhLFxuICAgIH07XG4gICAgaWYgKHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwucm9vdFNldFN0YXRlKSB7XG4gICAgICB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLnJvb3RTZXRTdGF0ZT8uKGNvbWJpbmVkU3RhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLnJvb3RTdGF0ZSA9IGNvbWJpbmVkU3RhdGU7XG4gICAgfVxuICB9XG4gIG1lcmdlTmV3Q29udGVudChuZXdDb250ZW50OiBCdWlsZGVyQ29udGVudCkge1xuICAgIGNvbnN0IG5ld0NvbnRlbnRWYWx1ZSA9IHtcbiAgICAgIC4uLnRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudCxcbiAgICAgIC4uLm5ld0NvbnRlbnQsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLnRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8uZGF0YSxcbiAgICAgICAgLi4ubmV3Q29udGVudD8uZGF0YSxcbiAgICAgIH0sXG4gICAgICBtZXRhOiB7XG4gICAgICAgIC4uLnRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8ubWV0YSxcbiAgICAgICAgLi4ubmV3Q29udGVudD8ubWV0YSxcbiAgICAgICAgYnJlYWtwb2ludHM6XG4gICAgICAgICAgbmV3Q29udGVudD8ubWV0YT8uYnJlYWtwb2ludHMgfHxcbiAgICAgICAgICB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQ/Lm1ldGE/LmJyZWFrcG9pbnRzLFxuICAgICAgfSxcbiAgICB9O1xuICAgIHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudCA9IG5ld0NvbnRlbnRWYWx1ZTtcbiAgfVxuICBnZXQgc2hvd0NvbnRlbnRQcm9wcygpIHtcbiAgICByZXR1cm4gdGhpcy5zaG93Q29udGVudFxuICAgICAgPyB7fVxuICAgICAgOiB7XG4gICAgICAgICAgaGlkZGVuOiB0cnVlLFxuICAgICAgICAgIFwiYXJpYS1oaWRkZW5cIjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgfVxuICBDb250ZW50V3JhcHBlciA9IG51bGw7XG4gIHByb2Nlc3NNZXNzYWdlKGV2ZW50OiBNZXNzYWdlRXZlbnQpIHtcbiAgICByZXR1cm4gY3JlYXRlRWRpdG9yTGlzdGVuZXIoe1xuICAgICAgbW9kZWw6IHRoaXMubW9kZWwsXG4gICAgICB0cnVzdGVkSG9zdHM6IHRoaXMudHJ1c3RlZEhvc3RzLFxuICAgICAgY2FsbGJhY2tzOiB7XG4gICAgICAgIGNvbmZpZ3VyZVNkazogKG1lc3NhZ2VDb250ZW50KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBicmVha3BvaW50cywgY29udGVudElkIH0gPSBtZXNzYWdlQ29udGVudDtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAhY29udGVudElkIHx8XG4gICAgICAgICAgICBjb250ZW50SWQgIT09IHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8uaWRcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGJyZWFrcG9pbnRzKSB7XG4gICAgICAgICAgICB0aGlzLm1lcmdlTmV3Q29udGVudCh7XG4gICAgICAgICAgICAgIG1ldGE6IHtcbiAgICAgICAgICAgICAgICBicmVha3BvaW50cyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgYW5pbWF0aW9uOiAoYW5pbWF0aW9uKSA9PiB7XG4gICAgICAgICAgdHJpZ2dlckFuaW1hdGlvbihhbmltYXRpb24pO1xuICAgICAgICB9LFxuICAgICAgICBjb250ZW50VXBkYXRlOiAobmV3Q29udGVudCkgPT4ge1xuICAgICAgICAgIHRoaXMubWVyZ2VOZXdDb250ZW50KG5ld0NvbnRlbnQpO1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KShldmVudCk7XG4gIH1cbiAgaHR0cFJlcXNEYXRhID0ge307XG4gIGh0dHBSZXFzUGVuZGluZyA9IHt9O1xuICBjbGlja2VkID0gZmFsc2U7XG4gIG9uQ2xpY2soZXZlbnQ6IGFueSkge1xuICAgIGlmICh0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQpIHtcbiAgICAgIGNvbnN0IHZhcmlhdGlvbklkID0gdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5jb250ZW50Py50ZXN0VmFyaWF0aW9uSWQ7XG4gICAgICBjb25zdCBjb250ZW50SWQgPSB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQ/LmlkO1xuICAgICAgX3RyYWNrKHtcbiAgICAgICAgYXBpSG9zdDogdGhpcy5hcGlIb3N0LFxuICAgICAgICB0eXBlOiBcImNsaWNrXCIsXG4gICAgICAgIGNhblRyYWNrOiBnZXREZWZhdWx0Q2FuVHJhY2sodGhpcy5jYW5UcmFjayksXG4gICAgICAgIGNvbnRlbnRJZCxcbiAgICAgICAgYXBpS2V5OiB0aGlzLmFwaUtleSxcbiAgICAgICAgdmFyaWF0aW9uSWQ6IHZhcmlhdGlvbklkICE9PSBjb250ZW50SWQgPyB2YXJpYXRpb25JZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgLi4uZ2V0SW50ZXJhY3Rpb25Qcm9wZXJ0aWVzRm9yRXZlbnQoZXZlbnQpLFxuICAgICAgICB1bmlxdWU6ICF0aGlzLmNsaWNrZWQsXG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmNsaWNrZWQpIHtcbiAgICAgIHRoaXMuY2xpY2tlZCA9IHRydWU7XG4gICAgfVxuICB9XG4gIHJ1bkh0dHBSZXF1ZXN0cygpIHtcbiAgICBjb25zdCByZXF1ZXN0czoge1xuICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH0gPSB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQ/LmRhdGE/Lmh0dHBSZXF1ZXN0cyA/PyB7fTtcbiAgICBPYmplY3QuZW50cmllcyhyZXF1ZXN0cykuZm9yRWFjaCgoW2tleSwgdXJsXSkgPT4ge1xuICAgICAgaWYgKCF1cmwpIHJldHVybjtcblxuICAgICAgLy8gcmVxdWVzdCBhbHJlYWR5IGluIHByb2dyZXNzXG4gICAgICBpZiAodGhpcy5odHRwUmVxc1BlbmRpbmdba2V5XSkgcmV0dXJuO1xuXG4gICAgICAvLyByZXF1ZXN0IGFscmVhZHkgY29tcGxldGVkLCBhbmQgbm90IGluIGVkaXQgbW9kZVxuICAgICAgaWYgKHRoaXMuaHR0cFJlcXNEYXRhW2tleV0gJiYgIWlzRWRpdGluZygpKSByZXR1cm47XG4gICAgICB0aGlzLmh0dHBSZXFzUGVuZGluZ1trZXldID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGV2YWx1YXRlZFVybCA9IHVybC5yZXBsYWNlKC97eyhbXn1dKyl9fS9nLCAoX21hdGNoLCBncm91cCkgPT5cbiAgICAgICAgU3RyaW5nKFxuICAgICAgICAgIGV2YWx1YXRlKHtcbiAgICAgICAgICAgIGNvZGU6IGdyb3VwLFxuICAgICAgICAgICAgY29udGV4dDogdGhpcy5jb250ZXh0IHx8IHt9LFxuICAgICAgICAgICAgbG9jYWxTdGF0ZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgcm9vdFN0YXRlOiB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLnJvb3RTdGF0ZSxcbiAgICAgICAgICAgIHJvb3RTZXRTdGF0ZTogdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5yb290U2V0U3RhdGUsXG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICAgIGxvZ0ZldGNoKGV2YWx1YXRlZFVybCk7XG4gICAgICBmZXRjaChldmFsdWF0ZWRVcmwpXG4gICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2UuanNvbigpKVxuICAgICAgICAudGhlbigoanNvbikgPT4ge1xuICAgICAgICAgIHRoaXMubWVyZ2VOZXdSb290U3RhdGUoe1xuICAgICAgICAgICAgW2tleV06IGpzb24sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5odHRwUmVxc0RhdGFba2V5XSA9IHRydWU7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihcImVycm9yIGZldGNoaW5nIGR5bmFtaWMgZGF0YVwiLCB1cmwsIGVycik7XG4gICAgICAgIH0pXG4gICAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmh0dHBSZXFzUGVuZGluZ1trZXldID0gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGVtaXRTdGF0ZVVwZGF0ZSgpIHtcbiAgICBpZiAoaXNFZGl0aW5nKCkpIHtcbiAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KFxuICAgICAgICBuZXcgQ3VzdG9tRXZlbnQ8QnVpbGRlckNvbXBvbmVudFN0YXRlQ2hhbmdlPihcbiAgICAgICAgICBcImJ1aWxkZXI6Y29tcG9uZW50OnN0YXRlQ2hhbmdlXCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZGV0YWlsOiB7XG4gICAgICAgICAgICAgIHN0YXRlOiBmYXN0Q2xvbmUodGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5yb290U3RhdGUpLFxuICAgICAgICAgICAgICByZWY6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLm1vZGVsLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIG5vZGVfMF9TaG93ID0gbnVsbDtcbiAgbm9kZV8yX3N0YXRlX0NvbnRlbnRXcmFwcGVyID0gbnVsbDtcbiAgbm9kZV8zX3N0YXRlX0NvbnRlbnRXcmFwcGVyID0gbnVsbDtcbiAgbWVyZ2VkSW5wdXRzX2VrYXdycSA9IHt9IGFzIGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZjUmVmOiBWaWV3Q29udGFpbmVyUmVmKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuQ29udGVudFdyYXBwZXIgPSB0aGlzLmNvbnRlbnRXcmFwcGVyIHx8IER5bmFtaWNEaXY7XG4gICAgdGhpcy5ydW5IdHRwUmVxdWVzdHMoKTtcbiAgICB0aGlzLmVtaXRTdGF0ZVVwZGF0ZSgpO1xuICAgIHRoaXMubm9kZV8wX1Nob3cgPVxuICAgICAgdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5jb250ZW50IHx8IG5lZWRzRWxlbWVudFJlZkRpdkZvckVkaXRpbmcoKTtcbiAgICB0aGlzLm5vZGVfMl9zdGF0ZV9Db250ZW50V3JhcHBlciA9IGdldFdyYXBwZXJDbGFzc05hbWUoXG4gICAgICB0aGlzLmNvbnRlbnQ/LnRlc3RWYXJpYXRpb25JZCB8fCB0aGlzLmNvbnRlbnQ/LmlkXG4gICAgKTtcbiAgICB0aGlzLm5vZGVfM19zdGF0ZV9Db250ZW50V3JhcHBlciA9IHtcbiAgICAgIGRpc3BsYXk6XG4gICAgICAgICF0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQgJiYgbmVlZHNFbGVtZW50UmVmRGl2Rm9yRWRpdGluZygpXG4gICAgICAgICAgPyBcIm5vbmVcIlxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgdGhpcy5tZXJnZWRJbnB1dHNfZWthd3JxID0ge1xuICAgICAgcmVmOiB0aGlzLmVsZW1lbnRSZWYsXG4gICAgICBvbkNsaWNrOiB0aGlzLm9uQ2xpY2suYmluZCh0aGlzKSxcbiAgICAgIFwiYnVpbGRlci1jb250ZW50LWlkXCI6IHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8uaWQsXG4gICAgICBcImJ1aWxkZXItbW9kZWxcIjogdGhpcy5tb2RlbCxcbiAgICAgIGNsYXNzTmFtZTogdGhpcy5ub2RlXzJfc3RhdGVfQ29udGVudFdyYXBwZXIsXG4gICAgICBzdHlsZTogdGhpcy5ub2RlXzNfc3RhdGVfQ29udGVudFdyYXBwZXIsXG4gICAgICAuLi50aGlzLnNob3dDb250ZW50UHJvcHMsXG4gICAgICAuLi50aGlzLmNvbnRlbnRXcmFwcGVyUHJvcHMsXG4gICAgfTtcblxuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBpZiAoaXNCcm93c2VyKCkpIHtcbiAgICAgICAgaWYgKGlzRWRpdGluZygpICYmICF0aGlzLmlzTmVzdGVkUmVuZGVyKSB7XG4gICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsICB0aGlzLnByb2Nlc3NNZXNzYWdlLmJpbmQodGhpcykpO1xuICAgICAgICAgIHJlZ2lzdGVySW5zZXJ0TWVudSgpO1xuICAgICAgICAgIHNldHVwQnJvd3NlckZvckVkaXRpbmcoe1xuICAgICAgICAgICAgLi4uKHRoaXMubG9jYWxlXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgbG9jYWxlOiB0aGlzLmxvY2FsZSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDoge30pLFxuICAgICAgICAgICAgLi4uKHRoaXMuZW5yaWNoXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW5yaWNoOiB0aGlzLmVucmljaCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDoge30pLFxuICAgICAgICAgICAgLi4uKHRoaXMudHJ1c3RlZEhvc3RzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgdHJ1c3RlZEhvc3RzOiB0aGlzLnRydXN0ZWRIb3N0cyxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDoge30pLFxuICAgICAgICAgICAgbW9kZWxOYW1lOiB0aGlzLm1vZGVsID8/IFwiXCIsXG4gICAgICAgICAgICBhcGlLZXk6IHRoaXMuYXBpS2V5LFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIE9iamVjdC52YWx1ZXM8Q29tcG9uZW50SW5mbz4oXG4gICAgICAgICAgICB0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbXBvbmVudEluZm9zXG4gICAgICAgICAgKS5mb3JFYWNoKChyZWdpc3RlcmVkQ29tcG9uZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICFyZWdpc3RlcmVkQ29tcG9uZW50Lm1vZGVscz8ubGVuZ3RoIHx8XG4gICAgICAgICAgICAgIHJlZ2lzdGVyZWRDb21wb25lbnQubW9kZWxzLmluY2x1ZGVzKHRoaXMubW9kZWwpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9XG4gICAgICAgICAgICAgICAgY3JlYXRlUmVnaXN0ZXJDb21wb25lbnRNZXNzYWdlKHJlZ2lzdGVyZWRDb21wb25lbnQpO1xuICAgICAgICAgICAgICB3aW5kb3cucGFyZW50Py5wb3N0TWVzc2FnZShtZXNzYWdlLCBcIipcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICAgICBcImJ1aWxkZXI6Y29tcG9uZW50OnN0YXRlQ2hhbmdlTGlzdGVuZXJBY3RpdmF0ZWRcIiwgXG4gICAgICAgICAgICB0aGlzLmVtaXRTdGF0ZVVwZGF0ZVxuICAgICAgICAgIC5iaW5kKHRoaXMpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzaG91bGRUcmFja0ltcHJlc3Npb24gPVxuICAgICAgICAgIHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudCAmJlxuICAgICAgICAgIGdldERlZmF1bHRDYW5UcmFjayh0aGlzLmNhblRyYWNrKTtcbiAgICAgICAgaWYgKHNob3VsZFRyYWNrSW1wcmVzc2lvbikge1xuICAgICAgICAgIGNvbnN0IHZhcmlhdGlvbklkID1cbiAgICAgICAgICAgIHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8udGVzdFZhcmlhdGlvbklkO1xuICAgICAgICAgIGNvbnN0IGNvbnRlbnRJZCA9IHRoaXMuYnVpbGRlckNvbnRleHRTaWduYWwuY29udGVudD8uaWQ7XG4gICAgICAgICAgY29uc3QgYXBpS2V5UHJvcCA9IHRoaXMuYXBpS2V5O1xuICAgICAgICAgIF90cmFjayh7XG4gICAgICAgICAgICBhcGlIb3N0OiB0aGlzLmFwaUhvc3QsXG4gICAgICAgICAgICB0eXBlOiBcImltcHJlc3Npb25cIixcbiAgICAgICAgICAgIGNhblRyYWNrOiB0cnVlLFxuICAgICAgICAgICAgY29udGVudElkLFxuICAgICAgICAgICAgYXBpS2V5OiBhcGlLZXlQcm9wISxcbiAgICAgICAgICAgIHZhcmlhdGlvbklkOiB2YXJpYXRpb25JZCAhPT0gY29udGVudElkID8gdmFyaWF0aW9uSWQgOiB1bmRlZmluZWQsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogT3ZlcnJpZGUgbm9ybWFsIGNvbnRlbnQgaW4gcHJldmlldyBtb2RlLlxuICAgICAgICAgKiBXZSBpZ25vcmUgdGhpcyB3aGVuIGVkaXRpbmcsIHNpbmNlIHRoZSBlZGl0ZWQgY29udGVudCBpcyBhbHJlYWR5IGJlaW5nIHNlbnQgZnJvbSB0aGUgZWRpdG9yIHZpYSBwb3N0IG1lc3NhZ2VzLlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKGlzUHJldmlld2luZygpICYmICFpc0VkaXRpbmcoKSkge1xuICAgICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IG5ldyBVUkwobG9jYXRpb24uaHJlZikuc2VhcmNoUGFyYW1zO1xuICAgICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtUHJldmlld01vZGVsID0gc2VhcmNoUGFyYW1zLmdldChcImJ1aWxkZXIucHJldmlld1wiKTtcbiAgICAgICAgICBjb25zdCBzZWFyY2hQYXJhbVByZXZpZXdJZCA9IHNlYXJjaFBhcmFtcy5nZXQoXG4gICAgICAgICAgICBgYnVpbGRlci5vdmVycmlkZXMuJHtzZWFyY2hQYXJhbVByZXZpZXdNb2RlbH1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBwcmV2aWV3QXBpS2V5ID1cbiAgICAgICAgICAgIHNlYXJjaFBhcmFtcy5nZXQoXCJhcGlLZXlcIikgfHwgc2VhcmNoUGFyYW1zLmdldChcImJ1aWxkZXIuc3BhY2VcIik7XG5cbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBNYWtlIHN1cmUgdGhhdDpcbiAgICAgICAgICAgKiAtIHRoZSBwcmV2aWV3IG1vZGVsIG5hbWUgaXMgdGhlIHNhbWUgYXMgdGhlIG9uZSB3ZSdyZSByZW5kZXJpbmcsIHNpbmNlIHRoZXJlIGNhbiBiZSBtdWx0aXBsZSBtb2RlbHMgcmVuZGVyZWRcbiAgICAgICAgICAgKiAgYXQgdGhlIHNhbWUgdGltZSwgZS5nLiBoZWFkZXIvcGFnZS9mb290ZXIuXG4gICAgICAgICAgICogLSB0aGUgQVBJIGtleSBpcyB0aGUgc2FtZSwgc2luY2Ugd2UgZG9uJ3Qgd2FudCB0byBwcmV2aWV3IGNvbnRlbnQgZnJvbSBvdGhlciBvcmdhbml6YXRpb25zLlxuICAgICAgICAgICAqIC0gaWYgdGhlcmUgaXMgY29udGVudCwgdGhhdCB0aGUgcHJldmlldyBJRCBpcyB0aGUgc2FtZSBhcyB0aGF0IG9mIHRoZSBvbmUgd2UgcmVjZWl2ZS5cbiAgICAgICAgICAgKlxuICAgICAgICAgICAqIFRPLURPOiBzaG91bGQgd2Ugb25seSB1cGRhdGUgdGhlIHN0YXRlIHdoZW4gdGhlcmUgaXMgYSBjaGFuZ2U/XG4gICAgICAgICAgICoqL1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtUHJldmlld01vZGVsID09PSBcIkJVSUxERVJfU1RVRElPXCIgfHxcbiAgICAgICAgICAgIChzZWFyY2hQYXJhbVByZXZpZXdNb2RlbCA9PT0gdGhpcy5tb2RlbCAmJlxuICAgICAgICAgICAgICBwcmV2aWV3QXBpS2V5ID09PSB0aGlzLmFwaUtleSAmJlxuICAgICAgICAgICAgICAoIXRoaXMuY29udGVudCB8fCBzZWFyY2hQYXJhbVByZXZpZXdJZCA9PT0gdGhpcy5jb250ZW50LmlkKSlcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGZldGNoT25lRW50cnkoe1xuICAgICAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCxcbiAgICAgICAgICAgICAgYXBpS2V5OiB0aGlzLmFwaUtleSxcbiAgICAgICAgICAgICAgYXBpVmVyc2lvbjogdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5hcGlWZXJzaW9uLFxuICAgICAgICAgICAgICAuLi4oc2VhcmNoUGFyYW1QcmV2aWV3TW9kZWwgPT09IFwiQlVJTERFUl9TVFVESU9cIiAmJlxuICAgICAgICAgICAgICB0aGlzLmNvbnRleHQ/LnN5bWJvbElkXG4gICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWQ6IHRoaXMuY29udGV4dC5zeW1ib2xJZCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA6IHt9KSxcbiAgICAgICAgICAgIH0pLnRoZW4oKGNvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1lcmdlTmV3Q29udGVudChjb250ZW50KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5teUNvbnRlbnQgPSBbXG4gICAgICB0aGlzLnZjUmVmLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLmNvbnRlbnR3cmFwcGVyVGVtcGxhdGVSZWYpLnJvb3ROb2RlcyxcbiAgICBdO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBpZiAodGhpcy5jb250ZW50KSB7XG4gICAgICAgIHRoaXMubWVyZ2VOZXdDb250ZW50KHRoaXMuY29udGVudCk7XG4gICAgICB9XG4gICAgICB0aGlzLmVtaXRTdGF0ZVVwZGF0ZSgpO1xuICAgICAgaWYgKHRoaXMuZGF0YSkge1xuICAgICAgICB0aGlzLm1lcmdlTmV3Um9vdFN0YXRlKHRoaXMuZGF0YSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5sb2NhbGUpIHtcbiAgICAgICAgdGhpcy5tZXJnZU5ld1Jvb3RTdGF0ZSh7XG4gICAgICAgICAgbG9jYWxlOiB0aGlzLmxvY2FsZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLm5vZGVfMF9TaG93ID1cbiAgICAgICAgdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5jb250ZW50IHx8IG5lZWRzRWxlbWVudFJlZkRpdkZvckVkaXRpbmcoKTtcbiAgICAgIHRoaXMubm9kZV8yX3N0YXRlX0NvbnRlbnRXcmFwcGVyID0gZ2V0V3JhcHBlckNsYXNzTmFtZShcbiAgICAgICAgdGhpcy5jb250ZW50Py50ZXN0VmFyaWF0aW9uSWQgfHwgdGhpcy5jb250ZW50Py5pZFxuICAgICAgKTtcbiAgICAgIHRoaXMubm9kZV8zX3N0YXRlX0NvbnRlbnRXcmFwcGVyID0ge1xuICAgICAgICBkaXNwbGF5OlxuICAgICAgICAgICF0aGlzLmJ1aWxkZXJDb250ZXh0U2lnbmFsLmNvbnRlbnQgJiYgbmVlZHNFbGVtZW50UmVmRGl2Rm9yRWRpdGluZygpXG4gICAgICAgICAgICA/IFwibm9uZVwiXG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIH07XG4gICAgICB0aGlzLm1lcmdlZElucHV0c19la2F3cnEgPSB7XG4gICAgICAgIHJlZjogdGhpcy5lbGVtZW50UmVmLFxuICAgICAgICBvbkNsaWNrOiB0aGlzLm9uQ2xpY2suYmluZCh0aGlzKSxcbiAgICAgICAgXCJidWlsZGVyLWNvbnRlbnQtaWRcIjogdGhpcy5idWlsZGVyQ29udGV4dFNpZ25hbC5jb250ZW50Py5pZCxcbiAgICAgICAgXCJidWlsZGVyLW1vZGVsXCI6IHRoaXMubW9kZWwsXG4gICAgICAgIGNsYXNzTmFtZTogdGhpcy5ub2RlXzJfc3RhdGVfQ29udGVudFdyYXBwZXIsXG4gICAgICAgIHN0eWxlOiB0aGlzLm5vZGVfM19zdGF0ZV9Db250ZW50V3JhcHBlcixcbiAgICAgICAgLi4udGhpcy5zaG93Q29udGVudFByb3BzLFxuICAgICAgICAuLi50aGlzLmNvbnRlbnRXcmFwcGVyUHJvcHMsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmIChpc0Jyb3dzZXIoKSkge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsICB0aGlzLnByb2Nlc3NNZXNzYWdlLmJpbmQodGhpcykpO1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgIFwiYnVpbGRlcjpjb21wb25lbnQ6c3RhdGVDaGFuZ2VMaXN0ZW5lckFjdGl2YXRlZFwiLCBcbiAgICAgICAgdGhpcy5lbWl0U3RhdGVVcGRhdGVcbiAgICAgIC5iaW5kKHRoaXMpKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==