import { SDK_VERSION } from '../constants/sdk-version';
import { TARGET } from '../constants/target';
import { isBrowser } from '../functions/is-browser';
import { isFromTrustedHost } from '../functions/is-from-trusted-host';
import { register } from '../functions/register';
export const registerInsertMenu = () => {
    register('insertMenu', {
        name: '_default',
        default: true,
        items: [{
                name: 'Box'
            }, {
                name: 'Text'
            }, {
                name: 'Image'
            }, {
                name: 'Columns'
            }, ...(TARGET === 'reactNative' ? [] : [{
                    name: 'Core:Section'
                }, {
                    name: 'Core:Button'
                }, {
                    name: 'Embed'
                }, {
                    name: 'Custom Code'
                }])]
    });
};
let isSetupForEditing = false;
export const setupBrowserForEditing = (options) => {
    if (isSetupForEditing) {
        return;
    }
    isSetupForEditing = true;
    if (isBrowser()) {
        window.parent?.postMessage({
            type: 'builder.sdkInfo',
            data: {
                target: TARGET,
                version: SDK_VERSION,
                supportsPatchUpdates: false,
                // Supports builder-model="..." attribute which is needed to
                // scope our '+ add block' button styling
                supportsAddBlockScoping: true,
                supportsCustomBreakpoints: true,
                modelName: options.modelName,
                apiKey: options.apiKey,
                supportsXSmallBreakpoint: TARGET === 'reactNative' ? false : true,
                blockLevelPersonalization: true
            }
        }, '*');
        window.parent?.postMessage({
            type: 'builder.updateContent',
            data: {
                options
            }
        }, '*');
        window.addEventListener('message', (event) => {
            if (!isFromTrustedHost(options.trustedHosts, event)) {
                return;
            }
            const { data } = event;
            if (!data?.type) {
                return;
            }
            switch (data.type) {
                case 'builder.evaluate':
                    {
                        const text = data.data.text;
                        const args = data.data.arguments || [];
                        const id = data.data.id;
                        // tslint:disable-next-line:no-function-constructor-with-string-args
                        const fn = new Function(text);
                        let result;
                        let error = null;
                        try {
                            // eslint-disable-next-line prefer-spread
                            result = fn.apply(null, args);
                        }
                        catch (err) {
                            error = err;
                        }
                        if (error) {
                            window.parent?.postMessage({
                                type: 'builder.evaluateError',
                                data: {
                                    id,
                                    error: error.message
                                }
                            }, '*');
                        }
                        else {
                            if (result && typeof result.then === 'function') {
                                result.then(finalResult => {
                                    window.parent?.postMessage({
                                        type: 'builder.evaluateResult',
                                        data: {
                                            id,
                                            result: finalResult
                                        }
                                    }, '*');
                                }).catch(console.error);
                            }
                            else {
                                window.parent?.postMessage({
                                    type: 'builder.evaluateResult',
                                    data: {
                                        result,
                                        id
                                    }
                                }, '*');
                            }
                        }
                        break;
                    }
            }
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1lZGl0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjcmlwdHMvaW5pdC1lZGl0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNqRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLEVBQUU7SUFDckMsUUFBUSxDQUFDLFlBQVksRUFBRTtRQUNyQixJQUFJLEVBQUUsVUFBVTtRQUNoQixPQUFPLEVBQUUsSUFBSTtRQUNiLEtBQUssRUFBRSxDQUFDO2dCQUNOLElBQUksRUFBRSxLQUFLO2FBQ1osRUFBRTtnQkFDRCxJQUFJLEVBQUUsTUFBTTthQUNiLEVBQUU7Z0JBQ0QsSUFBSSxFQUFFLE9BQU87YUFDZCxFQUFFO2dCQUNELElBQUksRUFBRSxTQUFTO2FBQ2hCLEVBQUUsR0FBRyxDQUFDLE1BQU0sS0FBSyxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdEMsSUFBSSxFQUFFLGNBQWM7aUJBQ3JCLEVBQUU7b0JBQ0QsSUFBSSxFQUFFLGFBQWE7aUJBQ3BCLEVBQUU7b0JBQ0QsSUFBSSxFQUFFLE9BQU87aUJBQ2QsRUFBRTtvQkFDRCxJQUFJLEVBQUUsYUFBYTtpQkFDcEIsQ0FBQyxDQUFDLENBQUM7S0FDTCxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFDRixJQUFJLGlCQUFpQixHQUFHLEtBQUssQ0FBQztBQUM5QixNQUFNLENBQUMsTUFBTSxzQkFBc0Is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QUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDOzZCQUN6QjtpQ0FBTTtnQ0FDTCxNQUFNLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQztvQ0FDekIsSUFBSSxFQUFFLHdCQUF3QjtvQ0FDOUIsSUFBSSxFQUFFO3dDQUNKLE1BQU07d0NBQ04sRUFBRTtxQ0FDSDtpQ0FDRixFQUFFLEdBQUcsQ0FBQyxDQUFDOzZCQUNUO3lCQUNGO3dCQUNELE1BQU07cUJBQ1A7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO0tBQ0o7QUFDSCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTREtfVkVSU0lPTiB9IGZyb20gJy4uL2NvbnN0YW50cy9zZGstdmVyc2lvbic7XG5pbXBvcnQgeyBUQVJHRVQgfSBmcm9tICcuLi9jb25zdGFudHMvdGFyZ2V0JztcbmltcG9ydCB7IGlzQnJvd3NlciB9IGZyb20gJy4uL2Z1bmN0aW9ucy9pcy1icm93c2VyJztcbmltcG9ydCB7IGlzRnJvbVRydXN0ZWRIb3N0IH0gZnJvbSAnLi4vZnVuY3Rpb25zL2lzLWZyb20tdHJ1c3RlZC1ob3N0JztcbmltcG9ydCB7IHJlZ2lzdGVyIH0gZnJvbSAnLi4vZnVuY3Rpb25zL3JlZ2lzdGVyJztcbmV4cG9ydCBjb25zdCByZWdpc3Rlckluc2VydE1lbnUgPSAoKSA9PiB7XG4gIHJlZ2lzdGVyKCdpbnNlcnRNZW51Jywge1xuICAgIG5hbWU6ICdfZGVmYXVsdCcsXG4gICAgZGVmYXVsdDogdHJ1ZSxcbiAgICBpdGVtczogW3tcbiAgICAgIG5hbWU6ICdCb3gnXG4gICAgfSwge1xuICAgICAgbmFtZTogJ1RleHQnXG4gICAgfSwge1xuICAgICAgbmFtZTogJ0ltYWdlJ1xuICAgIH0sIHtcbiAgICAgIG5hbWU6ICdDb2x1bW5zJ1xuICAgIH0sIC4uLihUQVJHRVQgPT09ICdyZWFjdE5hdGl2ZScgPyBbXSA6IFt7XG4gICAgICBuYW1lOiAnQ29yZTpTZWN0aW9uJ1xuICAgIH0sIHtcbiAgICAgIG5hbWU6ICdDb3JlOkJ1dHRvbidcbiAgICB9LCB7XG4gICAgICBuYW1lOiAnRW1iZWQnXG4gICAgfSwge1xuICAgICAgbmFtZTogJ0N1c3RvbSBDb2RlJ1xuICAgIH1dKV1cbiAgfSk7XG59O1xubGV0IGlzU2V0dXBGb3JFZGl0aW5nID0gZmFsc2U7XG5leHBvcnQgY29uc3Qgc2V0dXBCcm93c2VyRm9yRWRpdGluZyA9IChvcHRpb25zOiB7XG4gIG1vZGVsTmFtZTogc3RyaW5nO1xuICBhcGlLZXk6IHN0cmluZztcbiAgZW5yaWNoPzogYm9vbGVhbjtcbiAgaW5jbHVkZVJlZnM/OiBib29sZWFuO1xuICBsb2NhbGU/OiBzdHJpbmc7XG4gIHRydXN0ZWRIb3N0cz86IHN0cmluZ1tdO1xufSkgPT4ge1xuICBpZiAoaXNTZXR1cEZvckVkaXRpbmcpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaXNTZXR1cEZvckVkaXRpbmcgPSB0cnVlO1xuICBpZiAoaXNCcm93c2VyKCkpIHtcbiAgICB3aW5kb3cucGFyZW50Py5wb3N0TWVzc2FnZSh7XG4gICAgICB0eXBlOiAnYnVpbGRlci5zZGtJbmZvJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdGFyZ2V0OiBUQVJHRVQsXG4gICAgICAgIHZlcnNpb246IFNES19WRVJTSU9OLFxuICAgICAgICBzdXBwb3J0c1BhdGNoVXBkYXRlczogZmFsc2UsXG4gICAgICAgIC8vIFN1cHBvcnRzIGJ1aWxkZXItbW9kZWw9XCIuLi5cIiBhdHRyaWJ1dGUgd2hpY2ggaXMgbmVlZGVkIHRvXG4gICAgICAgIC8vIHNjb3BlIG91ciAnKyBhZGQgYmxvY2snIGJ1dHRvbiBzdHlsaW5nXG4gICAgICAgIHN1cHBvcnRzQWRkQmxvY2tTY29waW5nOiB0cnVlLFxuICAgICAgICBzdXBwb3J0c0N1c3RvbUJyZWFrcG9pbnRzOiB0cnVlLFxuICAgICAgICBtb2RlbE5hbWU6IG9wdGlvbnMubW9kZWxOYW1lLFxuICAgICAgICBhcGlLZXk6IG9wdGlvbnMuYXBpS2V5LFxuICAgICAgICBzdXBwb3J0c1hTbWFsbEJyZWFrcG9pbnQ6IFRBUkdFVCA9PT0gJ3JlYWN0TmF0aXZlJyA/IGZhbHNlIDogdHJ1ZSxcbiAgICAgICAgYmxvY2tMZXZlbFBlcnNvbmFsaXphdGlvbjogdHJ1ZVxuICAgICAgfVxuICAgIH0sICcqJyk7XG4gICAgd2luZG93LnBhcmVudD8ucG9zdE1lc3NhZ2Uoe1xuICAgICAgdHlwZTogJ2J1aWxkZXIudXBkYXRlQ29udGVudCcsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIG9wdGlvbnNcbiAgICAgIH1cbiAgICB9LCAnKicpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgIGlmICghaXNGcm9tVHJ1c3RlZEhvc3Qob3B0aW9ucy50cnVzdGVkSG9zdHMsIGV2ZW50KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB7XG4gICAgICAgIGRhdGFcbiAgICAgIH0gPSBldmVudDtcbiAgICAgIGlmICghZGF0YT8udHlwZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzd2l0Y2ggKGRhdGEudHlwZSkge1xuICAgICAgICBjYXNlICdidWlsZGVyLmV2YWx1YXRlJzpcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0ID0gZGF0YS5kYXRhLnRleHQ7XG4gICAgICAgICAgICBjb25zdCBhcmdzID0gZGF0YS5kYXRhLmFyZ3VtZW50cyB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZGF0YS5kYXRhLmlkO1xuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZ1bmN0aW9uLWNvbnN0cnVjdG9yLXdpdGgtc3RyaW5nLWFyZ3NcbiAgICAgICAgICAgIGNvbnN0IGZuID0gbmV3IEZ1bmN0aW9uKHRleHQpO1xuICAgICAgICAgICAgbGV0IHJlc3VsdDogYW55O1xuICAgICAgICAgICAgbGV0IGVycm9yOiBFcnJvciB8IG51bGwgPSBudWxsO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1zcHJlYWRcbiAgICAgICAgICAgICAgcmVzdWx0ID0gZm4uYXBwbHkobnVsbCwgYXJncyk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgZXJyb3IgPSAoZXJyIGFzIEVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICB3aW5kb3cucGFyZW50Py5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2J1aWxkZXIuZXZhbHVhdGVFcnJvcicsXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSwgJyonKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgKHJlc3VsdCBhcyBQcm9taXNlPGFueT4pLnRoZW4oZmluYWxSZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgICAgd2luZG93LnBhcmVudD8ucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnYnVpbGRlci5ldmFsdWF0ZVJlc3VsdCcsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IGZpbmFsUmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0sICcqJyk7XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goY29uc29sZS5lcnJvcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnBhcmVudD8ucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgdHlwZTogJ2J1aWxkZXIuZXZhbHVhdGVSZXN1bHQnLFxuICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQsXG4gICAgICAgICAgICAgICAgICAgIGlkXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgJyonKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG59Il19